<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRIOVA Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --primary-color: #667eea;
            --primary-dark: #5568d3;
            --secondary-color: #764ba2;
            --accent-color: #f093fb;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --bg-primary: #0a0e27;
            --bg-secondary: #151932;
            --bg-tertiary: #1a1f3a;
            --text-primary: #ffffff;
            --text-secondary: #a0aec0;
            --text-muted: #718096;
            --border-color: #2d3748;
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(148, 163, 184, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        h1, h2, h3, .font-display {
            font-family: 'Poppins', sans-serif;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 320px 1fr 400px;
            gap: 20px;
            padding: 20px;
            height: calc(100vh - 80px);
            position: relative;
            z-index: 1;
        }

        .panel {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 24px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .panel-header h2 {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .panel-content {
            padding: 24px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .panel-content::-webkit-scrollbar,
        #chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .panel-content::-webkit-scrollbar-track,
        #chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .panel-content::-webkit-scrollbar-thumb,
        #chat-messages::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 10px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 0.875rem;
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            transition: width 0.6s, height 0.6s, top 0.6s, left 0.6s;
            transform: translate(-50%, -50%);
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--bg-secondary);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .input-field {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 0.9375rem;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .input-field::placeholder {
            color: var(--text-muted);
        }

        #main-header {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 80px;
            position: relative;
            z-index: 10;
        }

        #main-header .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #main-header .logo-section img {
            height: 40px;
            width: auto;
            filter: brightness(1.2);
        }

        #main-header .logo-section span {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 1.5rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        #profile-avatar-initial {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.125rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-premium {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #78350f;
        }

        .status-free {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .auth-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 48px 40px;
            max-width: 480px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .source-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .source-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-gradient);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .source-card:hover {
            border-color: var(--primary-color);
            transform: translateX(4px);
        }

        .source-card:hover::before {
            transform: scaleY(1);
        }

        .chat-bubble {
            padding: 14px 18px;
            border-radius: 18px;
            max-width: 80%;
            line-height: 1.6;
            font-size: 0.9375rem;
            animation: messageSlide 0.3s ease;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-bubble.user {
            background: var(--primary-gradient);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .chat-bubble.ai {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }

        .message-row {
            display: flex;
            margin-bottom: 16px;
        }

        .message-row.user {
            justify-content: flex-end;
        }

        .message-row.ai {
            justify-content: flex-start;
        }

        .chat-input-wrapper {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 24px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
        }

        .chat-input-wrapper:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        #chat-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 0.9375rem;
        }

        .studio-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .studio-card:not(:disabled):hover {
            border-color: var(--primary-color);
            background: var(--bg-tertiary);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
        }

        .studio-card:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 20px;
            padding: 48px 24px;
            text-align: center;
            background: var(--bg-tertiary);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.05);
        }

        .placeholder-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: var(--text-muted);
            padding: 40px;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--bg-tertiary);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .profile-nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            border-radius: 12px;
            color: var(--text-secondary);
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 8px;
        }

        .profile-nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .profile-nav-item.active {
            background: var(--primary-gradient);
            color: white;
        }

        .tab-content-section {
            display: none;
        }

        .tab-content-section.active {
            display: block;
        }

        .premium-overlay {
            position: absolute;
            inset: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(4px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dropdown-menu {
            position: absolute;
            right: 0;
            top: calc(100% + 12px);
            min-width: 220px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .dropdown-menu.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .dropdown-item {
            display: block;
            padding: 12px 16px;
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 0.875rem;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .dropdown-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .pill-select {
            appearance: none;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 20px;
            padding: 8px 36px 8px 16px;
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23cbd5e1' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 20px;
        }

        .source-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .source-grid-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .source-grid-item:hover {
            background: var(--bg-secondary);
            border-color: var(--primary-color);
            color: var(--text-primary);
            transform: translateY(-2px);
        }

        #mobile-nav {
            display: none;
        }

        .mobile-nav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px;
            color: var(--text-muted);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mobile-nav-btn.active {
            color: var(--primary-color);
            background: rgba(102, 126, 234, 0.1);
        }

        #presentations-list-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .presentation-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            margin-bottom: 12px;
        }

        .presentation-item:hover {
            border-color: var(--primary-color);
            transform: translateX(4px);
        }

        .icon-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .icon-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        #debrief-content {
            color: var(--text-primary);
            line-height: 1.8;
        }

        #debrief-content h1,
        #debrief-content h2,
        #debrief-content h3 {
            color: var(--text-primary);
            margin-top: 24px;
            margin-bottom: 16px;
            font-weight: 700;
        }

        #debrief-content p {
            margin-bottom: 16px;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 1024px) {
            body {
                overflow-y: auto;
            }

            #main-header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 20;
            }

            #mobile-nav {
                display: flex;
                position: fixed;
                top: 80px;
                left: 0;
                right: 0;
                z-index: 19;
                background: var(--bg-secondary);
                border-bottom: 1px solid var(--border-color);
                padding: 0;
            }

            .main-grid {
                display: block;
                padding-top: 160px;
                padding-bottom: 24px;
                height: auto;
            }

            .main-grid > .panel {
                display: none;
                margin-bottom: 20px;
            }

            .main-grid > .panel.mobile-active {
                display: flex;
            }

            .source-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                padding: 24px;
                max-height: 85vh;
            }

            .auth-card {
                padding: 32px 24px;
            }

            #auth-section {
                position: fixed !important;
                inset: 0 !important;
                z-index: 100 !important;
                padding: 1rem;
                background: var(--bg-primary);
            }

            #auth-section.hidden {
                display: none !important;
            }

            #profile-modal .modal-content {
                flex-direction: column !important;
            }

            #profile-modal .modal-content > div:first-child {
                width: 100% !important;
                border-radius: 20px 20px 0 0 !important;
                border-right: none !important;
                border-bottom: 1px solid var(--border-color) !important;
            }

            #profile-modal .modal-content > div:last-child {
                width: 100% !important;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header id="main-header" class="hidden">
        <div class="logo-section">
            <img src="https://cdn.prod.website-files.com/68b9f8920957ffd144ee6dd0/68f2cd833c67a2590b977707_Logo%20only.png" alt="BRIOVA Logo">
            <span>BRIOVA</span>
        </div>

        <div style="display: flex; align-items: center; gap: 16px; position: relative;">
            <div id="user-status" class="status-badge status-free"></div>
            <div id="debriefs-remaining" class="status-badge status-free"></div>

            <button id="settings-button" class="icon-btn">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
            </button>

            <div id="settings-dropdown" class="dropdown-menu">
                <a href="#" class="dropdown-item">NotebookLM Help</a>
                <a href="#" class="dropdown-item">Send feedback</a>
                <a href="#" class="dropdown-item">Discord</a>
                <a href="#" class="dropdown-item">Output Language</a>
                <a href="#" class="dropdown-item">Device</a>
                <div style="height: 1px; background: var(--border-color); margin: 8px 0;"></div>
                <a href="#" class="dropdown-item">Upgrade to Plus</a>
            </div>

            <button id="profile-button">
                <div id="profile-avatar-initial">?</div>
            </button>

            <button id="logout-button" class="icon-btn" title="Déconnexion">
                <svg class="w-5 h-5" style="color: var(--danger-color);" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
            </button>
        </div>
    </header>

    <!-- Mobile Navigation -->
    <nav id="mobile-nav" class="hidden">
        <button id="mobile-nav-sources" class="mobile-nav-btn">
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <span>Sources</span>
        </button>
        <button id="mobile-nav-chat" class="mobile-nav-btn active">
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
            <span>Chat</span>
        </button>
        <button id="mobile-nav-studio" class="mobile-nav-btn">
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
            </svg>
            <span>Studio</span>
        </button>
    </nav>

    <!-- Loading Indicator -->
    <div id="loading-indicator" style="position: fixed; inset: 0; background: rgba(15, 23, 42, 0.95); z-index: 100; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(8px);">
        <div class="spinner"></div>
    </div>

    <!-- Temporary Loading Overlay -->
    <div id="temp-loading-overlay" class="hidden" style="position: fixed; bottom: 24px; right: 24px; z-index: 110; background: var(--bg-secondary); border: 1px solid var(--border-color); padding: 16px 20px; border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 12px;">
        <div class="spinner" style="width: 20px; height: 20px; border-width: 3px;"></div>
        <span id="temp-loading-message" style="color: var(--text-primary); font-size: 0.875rem;"></span>
    </div>

    <!-- Authentication Section -->
    <div id="auth-section" style="display: flex; align-items: center; justify-content: center; min-height: 100vh; position: relative; z-index: 1;" class="hidden">
        <div class="auth-card">
            <div style="text-align: center; margin-bottom: 32px;">
                <img src="https://cdn.prod.website-files.com/68b9f8920957ffd144ee6dd0/68d2e687122a4d05e0c8b291_Logo%20site%20web%20horiz.png" alt="BRIOVA Logo" style="height: 48px; margin: 0 auto;">
            </div>
            <h2 style="font-size: 1.75rem; font-weight: 700; text-align: center; margin-bottom: 8px; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Bienvenue sur BRIOVA</h2>
            <p style="text-align: center; color: var(--text-secondary); margin-bottom: 32px;">Connectez-vous pour continuer</p>
            <div style="display: flex; flex-direction: column; gap: 20px;">
                <div>
                    <label for="auth-email" style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px;">Adresse email</label>
                    <input type="email" id="auth-email" placeholder="nom@exemple.com" class="input-field">
                </div>
                <div>
                    <label for="auth-password" style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px;">Mot de passe</label>
                    <input type="password" id="auth-password" placeholder="••••••••" class="input-field">
                </div>
                <p id="auth-error" style="color: var(--danger-color); font-size: 0.875rem;" class="hidden"></p>
                <button id="login-button" class="btn btn-primary" style="width: 100%; padding: 16px;">Se Connecter</button>
            </div>
            <div style="text-align: center; margin-top: 24px;">
                <button id="show-signup-modal-button" style="font-size: 0.875rem; font-weight: 500; color: var(--primary-color); background: none; border: none; cursor: pointer;">Créer un compte</button>
                <span style="margin: 0 12px; color: var(--text-secondary);">|</span>
                <button id="show-forgot-password-modal" style="font-size: 0.875rem; font-weight: 500; color: var(--primary-color); background: none; border: none; cursor: pointer;">Mot de passe oublié ?</button>
            </div>
        </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard-section" class="main-grid hidden">
        <!-- Left Panel: Sources -->
        <div class="panel glass-panel">
            <div class="panel-header">
                <h2>Sources</h2>
                <button id="show-add-source-modal" class="btn btn-primary" style="padding: 10px 20px; font-size: 0.8125rem;">
                    <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                    </svg>
                    Ajouter
                </button>
            </div>
            <div class="panel-content">
                <div id="sources-table" style="display: flex; flex-direction: column; gap: 16px;"></div>
                <div id="sources-placeholder" class="placeholder-center">
                    <svg class="h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <p style="font-weight: 600; font-size: 1rem; margin-top: 16px;">Vos sources apparaîtront ici</p>
                    <p style="font-size: 0.875rem; margin-top: 8px;">Cliquez sur "Ajouter" pour commencer.</p>
                </div>
            </div>
            <div style="border-top: 1px solid var(--border-color); padding: 24px;">
                <h3 style="font-weight: 600; color: var(--text-primary); margin-bottom: 12px; font-size: 0.875rem;">Profil pour l'IA</h3>
                <textarea id="user-persona-input" rows="3" class="input-field" style="font-size: 0.875rem; resize: none;" placeholder="Ex: Spécialiste en marketing digital..."></textarea>
                <button onclick="saveUserPersona()" class="btn btn-secondary" style="margin-top: 12px; width: 100%; font-size: 0.875rem;">Valider Profil</button>
            </div>
        </div>

        <!-- Center Panel: Debrief -->
        <div class="panel glass-panel">
            <div class="panel-header">
                <h2>Débrief</h2>
                <div style="display: flex; align-items: center; gap: 16px;">
                    <label for="debrief-format-selector" style="font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); white-space: nowrap;">Format</label>
                    <select id="debrief-format-selector" onchange="saveReportFormat()" class="pill-select">
                        <option selected>Default format</option>
                        <option>🎓 EduScience Learning Format</option>
                        <option>📚 Research Digest Format</option>
                    </select>
                    <button id="copy-debrief-button" title="Copier le texte" class="icon-btn hidden">
                        <svg id="copy-icon" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                        <svg id="copy-success-icon" class="w-5 h-5 hidden" style="color: var(--success-color);" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="panel-content" style="position: relative;">
                <div id="blur-target">
                    <div id="debrief-content"></div>
                    <div id="debrief-placeholder" class="placeholder-center">
                        <svg class="h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                        </svg>
                        <p style="font-weight: 600; font-size: 1rem; margin-top: 16px;">Prêt à lancer un débrief ?</p>
                        <p style="font-size: 0.875rem; margin-top: 8px;">Ajoutez vos sources, puis cliquez sur le bouton ci-dessous.</p>
                    </div>
                </div>
                <div id="debrief-loading-overlay" class="hidden" style="position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(8px); z-index: 10; border-radius: 24px;">
                    <div class="spinner"></div>
                    <p style="margin-top: 24px; font-weight: 600; color: var(--text-primary); background: var(--bg-secondary); padding: 12px 24px; border-radius: 12px; border: 1px solid var(--border-color);">Création du débrief en cours...</p>
                </div>
            </div>
            <div style="padding: 24px; border-top: 1px solid var(--border-color);">
                <button id="start-debrief-button" class="btn btn-primary" style="width: 100%; padding: 16px;"></button>
                <p id="usage-limit" style="color: var(--text-muted); font-size: 0.75rem; text-align: center; margin-top: 12px;"></p>
            </div>
        </div>

        <!-- Right Panel: Studio & Chat -->
        <div class="panel glass-panel">
            <div class="panel-header">
                <h2>Studio</h2>
            </div>
            <div class="panel-content">
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="studio-card" disabled>
                        <svg class="h-6 w-6" style="color: var(--text-muted);" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.636 5.636a9 9 0 0112.728 0m12.728 12.728L5.636 5.636"/>
                        </svg>
                        <span style="font-weight: 600; font-size: 0.875rem;">Audio Overview</span>
                    </button>

                    <div style="position: relative;">
                        <button id="make-presentation-btn" class="studio-card" style="width: 100%;">
                            <svg class="h-6 w-6" style="color: var(--primary-color);" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                            </svg>
                            <span style="font-weight: 600; font-size: 0.875rem;">Make AI Presentation</span>
                        </button>
                        <div id="presentation-premium-overlay" class="premium-overlay hidden">
                            <svg class="w-8 h-8" style="color: var(--warning-color);" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
                            </svg>
                            <button style="margin-top: 12px; font-size: 0.875rem; font-weight: 600; color: var(--warning-color); background: none; border: none; cursor: pointer;">Passer Premium</button>
                        </div>
                    </div>
                </div>

                <div style="height: 1px; background: var(--border-color); margin: 24px 0;"></div>

                <div>
                    <h3 style="font-weight: 600; color: var(--text-primary); margin-bottom: 16px; font-size: 0.9375rem;">Vos Présentations</h3>
                    <div id="presentations-list-container" style="display: flex; flex-direction: column; gap: 12px;"></div>
                    <div id="presentations-list-placeholder" class="placeholder-center hidden" style="padding: 32px 16px;">
                        <p style="font-size: 0.875rem;">Aucune présentation sauvegardée.</p>
                    </div>
                </div>

                <div style="height: 1px; background: var(--border-color); margin: 24px 0;"></div>

                <div style="display: flex; flex-direction: column; height: 400px;">
                    <h3 style="font-weight: 600; color: var(--text-primary); margin-bottom: 16px; font-size: 0.9375rem;">Assistant IA</h3>
                    <div id="chat-messages" style="flex: 1; overflow-y: auto; padding: 16px; background: var(--bg-tertiary); border-radius: 16px; margin-bottom: 16px;">
                        <div id="chat-empty-state" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center;">
                            <h4 style="font-size: 1.125rem; font-weight: 600; color: var(--text-primary);">Comment puis-je vous aider ?</h4>
                        </div>
                    </div>
                    <form id="chat-form" class="chat-input-wrapper">
                        <button type="button" style="padding: 8px; color: var(--text-muted); background: none; border: none; cursor: pointer;">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/>
                            </svg>
                        </button>
                        <input id="chat-input" type="text" placeholder="Poser une question">
                        <button type="submit" style="padding: 10px; background: var(--primary-gradient); color: white; border-radius: 12px; border: none; cursor: pointer; transition: all 0.3s ease;">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- TOUS LES MODALS (Add Source, Profile, Presentation, etc.) -->
    <div id="add-source-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 700px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);">Ajouter des sources</h2>
                <button id="close-add-source-modal" style="width: 40px; height: 40px; border-radius: 10px; background: var(--bg-tertiary); border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; transition: all 0.3s ease;">&times;</button>
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 32px; font-size: 0.9375rem;">Les sources permettent à BRIOVA de baser ses réponses sur les informations qui vous importent le plus.</p>

            <div id="pdf-upload-area" class="upload-area" style="position: relative;">
                <input type="file" id="pdf-file-input" class="hidden" accept=".pdf">
                <div style="width: 64px; height: 64px; border-radius: 50%; background: rgba(102, 126, 234, 0.1); display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                    <svg class="w-8 h-8" style="color: var(--primary-color);" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l3 3m-3-3l-3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z"/>
                    </svg>
                </div>
                <p style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Upload sources</p>
                <p style="font-size: 0.875rem; color: var(--text-secondary);">Glissez & déposez ou <span style="color: var(--primary-color); font-weight: 600;">choisissez un fichier</span></p>

                <div id="upload-premium-overlay" class="premium-overlay hidden">
                    <svg class="w-8 h-8" style="color: var(--warning-color);" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
                    </svg>
                    <button style="margin-top: 12px; font-size: 0.875rem; font-weight: 600; color: var(--warning-color); background: none; border: none; cursor: pointer;">Passer Premium</button>
                </div>
            </div>

            <p style="font-size: 0.75rem; color: var(--text-muted); text-align: center; margin: 16px 0;">Types de fichiers supportés: PDF</p>

            <div class="source-grid">
                <button id="website-launcher-btn" class="source-grid-item">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.25 9.75h17.5M9 3.25a15.3 15.3 0 016 0m-6 17.5a15.3 15.3 0 006 0"></path>
                    </svg>
                    Website
                </button>
                <button id="youtube-launcher-btn" class="source-grid-item">
                    <svg class="h-5 w-5" style="color: #ef4444;" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/>
                    </svg>
                    YouTube
                </button>
                <button id="podcast-launcher-btn" class="source-grid-item">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5 5 0 010 7.424M6.75 8.25l4.5 4.5 4.5-4.5"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 21a9 9 0 100-18 9 9 0 000 18z"></path>
                    </svg>
                    Podcast
                </button>

                <div style="position: relative;">
                    <button id="text-launcher-btn" class="source-grid-item" style="width: 100%;">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Paste Text
                    </button>
                    <div id="paste-text-premium-overlay" class="premium-overlay hidden">
                        <svg class="w-6 h-6" style="color: var(--warning-color);" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Website Modal -->
    <div id="website-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 500px;">
            <h3 style="font-weight: 700; font-size: 1.25rem; margin-bottom: 20px; color: var(--text-primary);">Ajouter Website / RSS</h3>
            <input type="url" id="article-link-input" placeholder="Collez vos liens (séparés par une virgule)" class="input-field" style="margin-bottom: 24px;">
            <div style="display: flex; justify-content: flex-end; gap: 12px;">
                <button class="btn-close-sub-modal btn btn-secondary">Annuler</button>
                <button id="add-article-link-btn" class="btn btn-primary">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- YouTube Modal -->
    <div id="youtube-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 500px;">
            <h3 style="font-weight: 700; font-size: 1.25rem; margin-bottom: 20px; color: var(--text-primary);">Ajouter Vidéos YouTube</h3>
            <input type="url" id="youtube-link-input" placeholder="Collez vos liens (séparés par une virgule)" class="input-field" style="margin-bottom: 24px;">
            <div style="display: flex; justify-content: flex-end; gap: 12px;">
                <button class="btn-close-sub-modal btn btn-secondary">Annuler</button>
                <button id="add-youtube-link-btn" class="btn btn-primary">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Podcast Modal -->
    <div id="podcast-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 500px;">
            <h3 style="font-weight: 700; font-size: 1.25rem; margin-bottom: 20px; color: var(--text-primary);">Ajouter Podcast</h3>
            <div style="display: flex; flex-direction: column; gap: 16px;">
                <input type="url" id="podcast-link-input" placeholder="Lien RSS du podcast" class="input-field">
                <input type="text" id="podcast-title-input" placeholder="Titre de l'épisode (optionnel)" class="input-field">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
                <button class="btn-close-sub-modal btn btn-secondary">Annuler</button>
                <button id="add-podcast-btn" class="btn btn-primary">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Text Modal -->
    <div id="text-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 500px;">
            <h3 style="font-weight: 700; font-size: 1.25rem; margin-bottom: 20px; color: var(--text-primary);">Coller du Texte</h3>
            <textarea id="paste-text-input" rows="5" class="input-field" placeholder="Collez votre texte ici..." style="margin-bottom: 24px; resize: vertical;"></textarea>
            <div style="display: flex; justify-content: flex-end; gap: 12px;">
                <button class="btn-close-sub-modal btn btn-secondary">Annuler</button>
                <button id="add-text-btn" class="btn btn-primary" disabled>Ajouter (bientôt)</button>
            </div>
        </div>
    </div>

    <!-- Profile Modal + Presentation Modal + Generic Modal + Signup Modal (suite dans PARTIE 3 avec le JavaScript) -->
    <!-- Profile Modal -->
    <div id="profile-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 900px; display: flex; padding: 0; min-height: 500px;">
            <div style="width: 260px; background: var(--bg-tertiary); padding: 32px 24px; border-radius: 24px 0 0 24px;">
                <div style="margin-bottom: 32px;">
                    <h3 id="profile-modal-user-name" style="font-size: 1.125rem; font-weight: 700; margin-bottom: 4px; color: var(--text-primary);"></h3>
                    <p style="font-size: 0.875rem; color: var(--text-secondary);">Gérez votre compte</p>
                </div>
                <nav style="display: flex; flex-direction: column; gap: 4px;">
                    <a href="#" id="profile-tab-btn" class="profile-nav-item active">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        Profil
                    </a>
                    <a href="#" id="security-tab-btn" class="profile-nav-item">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.286zm0 13.036h.008v.008h-.008v-.008z"/>
                        </svg>
                        Sécurité
                    </a>
                    <a href="#" id="plans-tab-btn" class="profile-nav-item">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15A2.25 2.25 0 002.25 6.75v10.5A2.25 2.25 0 004.5 19.5z"/>
                        </svg>
                        Plans
                    </a>
                </nav>
            </div>

            <div style="flex: 1; padding: 40px; position: relative; overflow-y: auto;">
                <button id="close-profile-modal" style="position: absolute; top: 20px; right: 20px; width: 40px; height: 40px; border-radius: 10px; background: var(--bg-tertiary); border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; transition: all 0.3s ease;">&times;</button>

                <div id="profile-content-section" class="tab-content-section active">
                    <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 32px; color: var(--text-primary);">Informations du Profil</h3>
                    <div style="display: flex; flex-direction: column; gap: 20px; max-width: 400px;">
                        <div>
                            <label for="profile-name" style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px;">Nom</label>
                            <input type="text" id="profile-name" class="input-field">
                        </div>
                        <div>
                            <label for="profile-email" style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px;">Email</label>
                            <input type="email" id="profile-email" class="input-field" style="background: var(--bg-tertiary); cursor: not-allowed;" readonly>
                        </div>
                        <button id="save-profile-button" class="btn btn-primary">Enregistrer</button>
                    </div>
                </div>

                <div id="security-content-section" class="tab-content-section">
                    <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 32px; color: var(--text-primary);">Sécurité du Compte</h3>
                    <div style="display: flex; flex-direction: column; gap: 20px; max-width: 400px;">
                        <div>
                            <label for="security-old-password" style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px;">Ancien Mot de Passe</label>
                            <input type="password" id="security-old-password" class="input-field">
                        </div>
                        <div>
                            <label for="security-new-password" style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px;">Nouveau Mot de Passe</label>
                            <input type="password" id="security-new-password" class="input-field">
                        </div>
                        <div>
                            <label for="security-confirm-password" style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px;">Confirmer Nouveau Mot de Passe</label>
                            <input type="password" id="security-confirm-password" class="input-field">
                        </div>
                        <button id="update-password-button" class="btn btn-primary">Mettre à jour</button>
                    </div>
                </div>

                <div id="plans-content-section" class="tab-content-section">
                    <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 32px; color: var(--text-primary);">Gérer votre Abonnement</h3>
                    
                    <div style="background: var(--bg-tertiary); padding: 24px; border-radius: 16px; border: 1px solid var(--border-color); margin-bottom: 24px; max-width: 500px;">
                        <h4 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">Plan Actuel</h4>
                        <span id="plan-status-display" class="status-badge status-free">Free</span>
                    </div>

                    <div id="plans-upgrade-section" class="hidden" style="max-width: 500px; margin-bottom: 24px;">
                        <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); padding: 32px; border-radius: 16px; border: 2px solid var(--primary-color);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                                <div>
                                    <h4 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 8px; color: var(--text-primary);">Passer au Premium</h4>
                                    <p style="color: var(--text-secondary);">Débloquez toutes les fonctionnalités.</p>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary);">$9<span style="font-size: 1rem; font-weight: 400; color: var(--text-secondary);">/mois</span></div>
                                </div>
                            </div>
                            <button id="plans-upgrade-button" class="btn btn-primary" style="width: 100%;">Passer Premium</button>
                        </div>
                    </div>

                    <div id="plans-cancel-section" class="hidden" style="max-width: 500px;">
                        <div style="background: rgba(239, 68, 68, 0.05); padding: 24px; border-radius: 16px; border: 2px solid var(--danger-color);">
                            <h4 style="font-size: 1.125rem; font-weight: 700; margin-bottom: 8px; color: var(--text-primary);">Annuler votre abonnement</h4>
                            <p style="color: var(--text-secondary); margin-bottom: 20px;">Votre abonnement est actif.</p>
                            <button id="plans-cancel-button" class="btn btn-danger" style="width: 100%;">Annuler l'abonnement</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Generic Modal -->
    <div id="generic-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 450px; text-align: center;">
            <div id="generic-modal-icon" style="margin: 0 auto 20px;"></div>
            <h3 id="generic-modal-title" style="font-size: 1.5rem; font-weight: 700; margin-bottom: 12px; color: var(--text-primary);"></h3>
            <p id="generic-modal-message" style="color: var(--text-secondary); margin-bottom: 32px;"></p>
            <div id="generic-modal-actions" style="display: flex; gap: 12px;"></div>
        </div>
    </div>

    <!-- Presentation Modal -->
    <div id="presentation-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 90vw; height: 90vh; display: flex; flex-direction: column; padding: 32px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);">Votre Présentation IA</h2>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button id="zoom-out-btn" title="Zoom arrière" class="icon-btn">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"/>
                        </svg>
                    </button>
                    <button id="zoom-in-btn" title="Zoom avant" class="icon-btn">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m-3-3h6"/>
                        </svg>
                    </button>
                    <button id="download-presentation-btn" class="btn btn-primary" style="padding: 10px 20px;">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        Download
                    </button>
                    <button id="close-presentation-modal" style="width: 40px; height: 40px; border-radius: 10px; background: var(--bg-tertiary); border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
            </div>
            <div id="presentation-content" style="flex: 1; overflow: auto; background: var(--bg-tertiary); border-radius: 16px; border: 1px solid var(--border-color);"></div>
        </div>
    </div>

    <!-- Signup Modal -->
    <div id="signup-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 450px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);">Créer un compte</h2>
                <button id="close-signup-modal" style="width: 40px; height: 40px; border-radius: 10px; background: var(--bg-tertiary); border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div style="display: flex; flex-direction: column; gap: 20px;">
                <div>
                    <label for="signup-name" style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px;">Nom</label>
                    <input type="text" id="signup-name" placeholder="Votre nom" class="input-field">
                </div>
                <div>
                    <label for="signup-email" style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px;">Email</label>
                    <input type="email" id="signup-email" placeholder="nom@exemple.com" class="input-field">
                </div>
                <div>
                    <label for="signup-password" style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px;">Mot de passe</label>
                    <input type="password" id="signup-password" placeholder="••••••••" class="input-field">
                </div>
                <p id="signup-error" style="color: var(--danger-color); font-size: 0.875rem;" class="hidden"></p>
                <button id="signup-button" class="btn btn-primary" style="width: 100%; padding: 16px;">Créer un compte</button>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 450px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);">Mot de passe oublié</h2>
                <button id="close-forgot-password-modal" style="width: 40px; height: 40px; border-radius: 10px; background: var(--bg-tertiary); border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div style="display: flex; flex-direction: column; gap: 20px;">
                <div>
                    <label for="forgot-password-email" style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px;">Email</label>
                    <input type="email" id="forgot-password-email" placeholder="nom@exemple.com" class="input-field">
                </div>
                <p id="forgot-password-error" style="color: var(--danger-color); font-size: 0.875rem;" class="hidden"></p>
                <button id="send-reset-email-button" class="btn btn-primary" style="width: 100%; padding: 16px;">Envoyer le lien</button>
            </div>
        </div>
    </div>

    <!-- Signup Success Modal -->
    <div id="signup-success-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 450px; text-align: center;">
            <svg class="w-16 h-16" style="color: var(--success-color); margin: 0 auto 20px;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 12px; color: var(--text-primary);">Compte créé !</h3>
            <p style="color: var(--text-secondary); margin-bottom: 32px;">Votre compte a été créé avec succès.</p>
            <button id="close-signup-success-modal" class="btn btn-primary" style="width: 100%;">Continuer</button>
        </div>
    </div>

    <!-- SCRIPT JAVASCRIPT COMPLET -->
    <script>
    // ================================================================
    // CONFIGURATION FIREBASE (100% PRÉSERVÉE)
    // ================================================================
    const firebaseConfig = {
        apiKey: "AIzaSyBxt3psNIY8yFbzmSUURXK_Ne5jnagbZTQ",
        authDomain: "brieova-f3288.firebaseapp.com",
        projectId: "brieova-f3288",
        storageBucket: "brieova-f3288.appspot.com",
        messagingSenderId: "931818128414",
        appId: "1:931818128414:web:8ee00d3f3bfd5fc9f21a0f"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch((error) => console.error("Erreur persistance :", error));

    // ================================================================
    // VARIABLES GLOBALES (100% PRÉSERVÉES)
    // ================================================================
    const USER_ACTIONS_WEBHOOK_URL = 'https://n8n.brieova.com/webhook/user-actions';
    const CHAT_WEBHOOK_URL = 'https://n8n.brieova.com/webhook/chat-assistant';
    let userRecord = null;
    let firebaseUser = null;
    let currentScale = 1.0;
    const zoomStep = 0.1;
    const minScale = 0.5;
    const maxScale = 3.0;
    let presentationIframe = null;

    // ================================================================
    // FONCTIONS ORIGINALES 100% PRÉSERVÉES
    // ================================================================
    
    function showNotification(title, message, type = 'success') {
        return new Promise(resolve => {
            const modal = document.getElementById('generic-modal');
            const iconContainer = document.getElementById('generic-modal-icon');
            const titleEl = document.getElementById('generic-modal-title');
            const messageEl = document.getElementById('generic-modal-message');
            const actionsEl = document.getElementById('generic-modal-actions');
            
            titleEl.textContent = title;
            messageEl.textContent = message;
            actionsEl.innerHTML = '';
            iconContainer.innerHTML = '';
            
            const icons = {
                success: `<svg class="w-12 h-12" style="color: var(--success-color);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`,
                error: `<svg class="w-12 h-12" style="color: var(--danger-color);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
                confirm: `<svg class="w-12 h-12" style="color: var(--warning-color);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
            };
            
            iconContainer.innerHTML = icons[type];
            
            if (type === 'confirm') {
                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'Annuler';
                cancelButton.className = 'btn btn-secondary';
                cancelButton.style.flex = '1';
                cancelButton.onclick = () => { modal.classList.add('hidden'); resolve(false); };
                
                const confirmButton = document.createElement('button');
                confirmButton.textContent = 'Confirmer';
                confirmButton.className = 'btn btn-primary';
                confirmButton.style.flex = '1';
                confirmButton.onclick = () => { modal.classList.add('hidden'); resolve(true); };
                
                actionsEl.appendChild(cancelButton);
                actionsEl.appendChild(confirmButton);
            } else {
                const okButton = document.createElement('button');
                okButton.textContent = 'OK';
                okButton.className = 'btn btn-primary';
                okButton.style.width = '100%';
                okButton.onclick = () => { modal.classList.add('hidden'); resolve(true); };
                actionsEl.appendChild(okButton);
            }
            
            modal.classList.remove('hidden');
        });
    }

    function showPresentationModal(htmlContent) {
        const modal = document.getElementById('presentation-modal');
        const contentDiv = document.getElementById('presentation-content');
        
        if (!modal || !contentDiv) {
            console.error('Modal de présentation introuvable.');
            return;
        }

        contentDiv.innerHTML = `<iframe srcdoc="${htmlContent.replace(/"/g, "'")}" style="width:100%; height:100%; border:none;"></iframe>`;
        presentationIframe = contentDiv.querySelector('iframe');
        currentScale = 1.0;
        updateZoom();
        
        modal.classList.remove('hidden');
    }

    async function handleDeletePresentation(button, presentationId) {
        if (!presentationId) return;

        const confirmed = await showNotification('Confirmer la suppression', 'Voulez-vous vraiment supprimer cette présentation ?', 'confirm');
        if (!confirmed) return;

        button.disabled = true;
        button.textContent = '...';

        try {
            await callN8n('deletePresentation', { 
                recordId: userRecord.id, 
                presentationId: presentationId 
            });
            
            await loadSavedPresentations();
            showNotification('Succès', 'Présentation supprimée.', 'success');
        } catch (error) {
            showNotification('Erreur', `La suppression a échoué: ${error.message}`, 'error');
            button.disabled = false;
            button.textContent = 'Supprimer';
        }
    }

    async function loadSavedPresentations() {
        const listContainer = document.getElementById('presentations-list-container');
        const placeholder = document.getElementById('presentations-list-placeholder');
        if (!listContainer || !placeholder) return;

        listContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary); font-size: 0.875rem;">Chargement...</div>';
        placeholder.classList.add('hidden');

        try {
            const presentations = await callN8n('getPresentations', { recordId: userRecord.id });

            listContainer.innerHTML = '';
            
            if (!presentations || presentations.length === 0) {
                placeholder.classList.remove('hidden');
                return;
            }

            presentations.sort((a, b) => b.id.localeCompare(a.id));

            presentations.forEach(pres => {
                const presId = pres.id;
                const title = pres.Title || 'Présentation sans titre';
                const htmlContent = pres.ContentHTML;

                const itemEl = document.createElement('div');
                itemEl.className = 'presentation-item';
                
                const titleEl = document.createElement('span');
                titleEl.style.cssText = 'font-weight: 500; font-size: 0.875rem; color: var(--text-primary); flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer;';
                titleEl.textContent = title;
                titleEl.title = title;
                
                titleEl.onclick = () => {
                    if (htmlContent) {
                        showPresentationModal(htmlContent);
                    } else {
                        showNotification('Erreur', 'Contenu de la présentation introuvable.', 'error');
                    }
                };
                
                const deleteBtn = document.createElement('button');
                deleteBtn.style.cssText = 'font-size: 0.75rem; color: var(--text-secondary); background: none; border: none; cursor: pointer; transition: color 0.3s ease; padding: 4px 12px;';
                deleteBtn.textContent = 'Supprimer';
                
                deleteBtn.onmouseover = () => { deleteBtn.style.color = 'var(--danger-color)'; };
                deleteBtn.onmouseout = () => { deleteBtn.style.color = 'var(--text-secondary)'; };
                
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    handleDeletePresentation(deleteBtn, presId);
                };

                itemEl.appendChild(titleEl);
                itemEl.appendChild(deleteBtn);
                listContainer.appendChild(itemEl);
            });

        } catch (error) {
            console.error('Erreur lors du chargement des présentations:', error);
            listContainer.innerHTML = '';
            placeholder.classList.remove('hidden');
        }
    }

    async function callN8n(action, data = {}) {
        if (!auth.currentUser) throw new Error("Utilisateur non authentifié.");
        const idToken = await auth.currentUser.getIdToken(true);
        const response = await fetch(USER_ACTIONS_WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${idToken}` },
            body: JSON.stringify({ action, ...data })
        });
        if (!response.ok) throw new Error(`Le serveur a refusé la requête : ${response.status}`);
        return await response.json();
    }

    function updateLocalUserRecord(recordFromN8n) {
        let p = Array.isArray(recordFromN8n) && recordFromN8n.length > 0 ? recordFromN8n[0] : recordFromN8n;
        if (!p || typeof p !== 'object' || !p.id) return;
        userRecord = p.fields ? p : { id: p.id, fields: { ...p } };
    }

    async function getUserDataByEmail(email) {
        const rawResult = await callN8n('findUser', { email });
        updateLocalUserRecord(rawResult);
        if (!userRecord) throw new Error("Utilisateur non trouvé.");
    }

    async function createUserData(email, name) {
        await callN8n('createUser', { email, name });
    }

    async function addLink(fieldName, inputId) {
        const inputElement = document.getElementById(inputId);
        const newLinksRaw = inputElement.value.trim();
        if (!newLinksRaw) return;
        const newLinks = newLinksRaw.split(',').map(link => link.trim()).filter(Boolean);
        const youtubeRegex = /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.?be)\/.+$/;
        for (const link of newLinks) {
            const isYoutubeLink = youtubeRegex.test(link);
            if (fieldName === 'YouTube Links') {
                if (!isYoutubeLink) {
                    showNotification('Lien invalide', `"${link}" n'est pas un lien YouTube valide.`, 'error');
                    return;
                }
            } else {
                if (isYoutubeLink) {
                    showNotification('Lien incorrect', 'Veuillez ajouter les liens YouTube dans la section dédiée.', 'error');
                    return;
                }
            }
        }
        const existingLinks = userRecord.fields[fieldName] ? String(userRecord.fields[fieldName]).split(',').filter(Boolean) : [];
        const allLinks = [...new Set([...existingLinks, ...newLinks])].join(',');
        try {
            updateLocalUserRecord(await callN8n('addLink', { recordId: userRecord.id, fieldName, allLinks }));
            inputElement.value = '';
            showDashboard();
        } catch (e) {
            showNotification('Erreur', e.message, 'error');
        }
    }

    async function saveUserPersona() {
        if (!userRecord) return;
        const personaText = document.getElementById('user-persona-input').value.trim();
        try {
            const updatedRecord = await callN8n('updateUserPersona', {
                recordId: userRecord.id,
                personaText: personaText
            });
            updateLocalUserRecord(updatedRecord);
            showNotification('Profil Enregistré', 'Votre profil pour l\'IA a été mis à jour.', 'success');
        } catch (error) {
            showNotification('Erreur', "Erreur lors de la sauvegarde du profil : " + error.message, 'error');
        }
    }

    async function saveReportFormat() {
        if (!userRecord) return;
        const selectedFormat = document.getElementById('debrief-format-selector').value;
        try {
            await callN8n('updateReportFormat', { recordId: userRecord.id, reportFormat: selectedFormat });
            console.log("Format de rapport sauvegardé :", selectedFormat);
        } catch (error) {
            console.error("Erreur lors de la sauvegarde du format:", error);
        }
    }

    async function addPodcast() {
        const newLink = document.getElementById('podcast-link-input').value.trim();
        const newTitle = document.getElementById('podcast-title-input').value.trim();
        if (!newLink) {
            showNotification("Attention", "Veuillez fournir le lien RSS du podcast.", 'error');
            return;
        }
        const youtubeRegex = /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.?be)\/.+$/;
        if (youtubeRegex.test(newLink)) {
            showNotification('Lien incorrect', 'Veuillez ajouter les liens YouTube dans la section dédiée.', 'error');
            return;
        }
        let podcasts = [];
        try {
            podcasts = JSON.parse(userRecord.fields['Podcast RSS Links'] || '[]');
        } catch (e) {
            console.error("Could not parse podcast JSON", e);
        }
        podcasts.push({ link: newLink, title: newTitle });
        try {
            updateLocalUserRecord(await callN8n('updatePodcasts', { recordId: userRecord.id, podcastData: JSON.stringify(podcasts) }));
            document.getElementById('podcast-link-input').value = '';
            document.getElementById('podcast-title-input').value = '';
            showDashboard();
        } catch (e) {
            showNotification('Erreur', e.message, 'error');
        }
    }

    async function clearLinks(fieldName) {
        if (await showNotification('Confirmation', 'Vider tous les liens de cette catégorie ?', 'confirm')) {
            try {
                updateLocalUserRecord(await callN8n('clearLinks', { recordId: userRecord.id, fieldName }));
                showDashboard();
            } catch (e) { showNotification('Erreur', e.message, 'error'); }
        }
    }

    async function clearPodcast() {
        if (await showNotification('Confirmation', 'Vider tous les podcasts ?', 'confirm')) {
            try {
                updateLocalUserRecord(await callN8n('updatePodcasts', { recordId: userRecord.id, podcastData: '[]' }));
                showDashboard();
            } catch (e) { showNotification('Erreur', e.message, 'error'); }
        }
    }

    async function startDebrief() {
        if (!userRecord || !userRecord.fields) return;
        const personaText = userRecord.fields['User Persona (AI)'] || '';
        if (personaText.trim() === '') {
            showNotification("Profil manquant", "Veuillez décrire votre profil avant de lancer un débrief.", 'error');
            return;
        }
        const hasLinks = userRecord.fields['Article RSS Links'] || userRecord.fields['YouTube Links'] || (userRecord.fields['Podcast RSS Links'] && userRecord.fields['Podcast RSS Links'] !== '[]') || userRecord.fields['PdfFiles'];
        if (!hasLinks) {
            showNotification("Sources manquantes", "Vous devez ajouter au moins une source avant de lancer le débrief.", 'error');
            return;
        }
        const debriefButton = document.getElementById('start-debrief-button');
        const loadingOverlay = document.getElementById('debrief-loading-overlay');
        const blurTarget = document.getElementById('blur-target');
        
        debriefButton.disabled = true;
        blurTarget.style.filter = 'blur(4px)';
        loadingOverlay.classList.remove('hidden');
        
        try {
            await callN8n('startDebrief', {
                recordId: userRecord.id,
                reportFormat: document.getElementById('debrief-format-selector').value
            });
            pollDebriefStatus(userRecord.id);
        } catch (error) {
            showNotification('Erreur', "Erreur lors du lancement du débrief: " + error.message, 'error');
            blurTarget.style.filter = 'none';
            loadingOverlay.classList.add('hidden');
            updateUsageLimit();
        }
    }

    function pollDebriefStatus(recordId) {
        let attempts = 0;
        const maxAttempts = 24;
        const intervalId = setInterval(async () => {
            if (attempts >= maxAttempts) {
                clearInterval(intervalId);
                showNotification('Délai dépassé', 'La création du débrief prend plus de temps que prévu. Vous recevrez le résultat par email.', 'error');
                document.getElementById('blur-target').style.filter = 'none';
                document.getElementById('debrief-loading-overlay').classList.add('hidden');
                updateUsageLimit();
                return;
            }
            try {
                const response = await callN8n('checkDebriefStatus', { recordId: recordId });
                if (response.status === 'complete') {
                    clearInterval(intervalId);
                    location.reload();
                }
            } catch (error) {
                clearInterval(intervalId);
                showNotification('Erreur', 'Impossible de vérifier le statut du débrief.', 'error');
                document.getElementById('blur-target').style.filter = 'none';
                document.getElementById('debrief-loading-overlay').classList.add('hidden');
                updateUsageLimit();
            }
            attempts++;
        }, 5000);
    }

    function showTab(tabName) {
        document.querySelectorAll('.tab-content-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.profile-nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById(`${tabName}-content-section`)?.classList.add('active');
        document.getElementById(`${tabName}-tab-btn`)?.classList.add('active');
    }

    function updateSourcesTable() {
        const tableBody = document.getElementById('sources-table');
        const placeholder = document.getElementById('sources-placeholder');
        if (!tableBody || !placeholder || !userRecord) return;
        
        tableBody.innerHTML = '';
        let hasContent = false;
        
        const fields = [
            { n: 'Article RSS Links', t: 'Articles / RSS' },
            { n: 'YouTube Links', t: 'Vidéos YouTube' },
            { n: 'Podcast RSS Links', t: 'Podcasts' },
            { n: 'PdfFiles', t: 'Fichiers PDF' }
        ];
        
        fields.forEach(f => {
            let contentExists = false, cardContent = '', clearAction = '';
            const fieldData = userRecord.fields[f.n];
            
            if (f.n === 'Podcast RSS Links') {
                let p = [];
                try { p = JSON.parse(fieldData || '[]'); } catch (e) {}
                if (p.length > 0) {
                    contentExists = true;
                    cardContent = p.map(i => `<div style="font-size: 0.75rem; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${i.link}">${i.title || i.link}</div>`).join('');
                    clearAction = `clearPodcast()`;
                }
            } else if (f.n === 'PdfFiles') {
                if (Array.isArray(fieldData) && fieldData.length > 0) {
                    contentExists = true;
                    cardContent = fieldData.map(file => `<div style="font-size: 0.75rem; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${file.url}">${file.filename}</div>`).join('');
                    clearAction = `clearLinks('PdfFiles')`;
                }
            } else {
                const links = fieldData ? String(fieldData).split(',').filter(Boolean) : [];
                if (links.length > 0) {
                    contentExists = true;
                    cardContent = links.map(l => `<div style="font-size: 0.75rem; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${l}">${l}</div>`).join('');
                    clearAction = `clearLinks('${f.n}')`;
                }
            }
            
            if (contentExists) {
                hasContent = true;
                const card = document.createElement('div');
                card.className = 'source-card';
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="font-weight: 600; font-size: 0.875rem; color: var(--text-primary);">${f.t}</h4>
                        <button onclick="${clearAction}" style="font-size: 0.75rem; color: var(--text-secondary); background: none; border: none; cursor: pointer; transition: color 0.3s ease;" onmouseover="this.style.color='var(--danger-color)'" onmouseout="this.style.color='var(--text-secondary)'">Vider</button>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto;">${cardContent}</div>
                `;
                tableBody.appendChild(card);
            }
        });
        
        if (hasContent) {
            placeholder.classList.add('hidden');
            tableBody.style.display = 'flex';
        } else {
            placeholder.classList.remove('hidden');
            tableBody.style.display = 'none';
        }
    }

    function updateUsageLimit() {
        const usageEl = document.getElementById('usage-limit');
        const debriefButton = document.getElementById('start-debrief-button');
        if (!usageEl || !debriefButton || !userRecord) return;
        
        const isPremium = userRecord.fields['Premium Status'] === 'Premium';
        const debriefCount = parseInt(userRecord.fields['Debrief Count'] || 0);
        const maxDebriefs = isPremium ? 999999 : 3;
        const remaining = Math.max(0, maxDebriefs - debriefCount);
        
        if (isPremium) {
            usageEl.textContent = 'Utilisations : Illimitées (Premium)';
            debriefButton.textContent = '✨ Générer le Débrief Premium';
            debriefButton.disabled = false;
        } else {
            usageEl.textContent = `Utilisations restantes : ${remaining} / ${maxDebriefs}`;
            if (remaining > 0) {
                debriefButton.textContent = '🚀 Lancer le Débrief';
                debriefButton.disabled = false;
            } else {
                debriefButton.textContent = '🔒 Limite Atteinte - Passer Premium';
                debriefButton.disabled = true;
            }
        }
    }

    function updateUIForSubscription() {
        if (!userRecord) return;
        const isPremium = userRecord.fields['Premium Status'] === 'Premium';
        
        document.getElementById('user-status').textContent = isPremium ? 'Premium' : 'Free';
        document.getElementById('user-status').className = isPremium ? 'status-badge status-premium' : 'status-badge status-free';
        
        const uploadOverlay = document.getElementById('upload-premium-overlay');
        const pasteTextOverlay = document.getElementById('paste-text-premium-overlay');
        const presentationOverlay = document.getElementById('presentation-premium-overlay');
        
        if (isPremium) {
            uploadOverlay?.classList.add('hidden');
            pasteTextOverlay?.classList.add('hidden');
            presentationOverlay?.classList.add('hidden');
            document.getElementById('pdf-upload-area').style.pointerEvents = 'auto';
            document.getElementById('make-presentation-btn').disabled = false;
            document.getElementById('text-launcher-btn').disabled = false;
        } else {
            uploadOverlay?.classList.remove('hidden');
            pasteTextOverlay?.classList.remove('hidden');
            presentationOverlay?.classList.remove('hidden');
            document.getElementById('pdf-upload-area').style.pointerEvents = 'none';
            document.getElementById('make-presentation-btn').disabled = true;
            document.getElementById('text-launcher-btn').disabled = true;
        }
        
        const planStatusDisplay = document.getElementById('plan-status-display');
        const upgradeSection = document.getElementById('plans-upgrade-section');
        const cancelSection = document.getElementById('plans-cancel-section');
        
        if (planStatusDisplay) {
            planStatusDisplay.textContent = isPremium ? 'Premium' : 'Free';
            planStatusDisplay.className = isPremium ? 'status-badge status-premium' : 'status-badge status-free';
        }
        
        if (isPremium) {
            upgradeSection?.classList.add('hidden');
            cancelSection?.classList.remove('hidden');
        } else {
            upgradeSection?.classList.remove('hidden');
            cancelSection?.classList.add('hidden');
        }
        
        updateUsageLimit();
    }

    async function sendChatMessage(message) {
        if (!userRecord || !message.trim()) return;
        
        const chatMessages = document.getElementById('chat-messages');
        const emptyState = document.getElementById('chat-empty-state');
        
        if (emptyState) emptyState.style.display = 'none';
        
        const userMsgRow = document.createElement('div');
        userMsgRow.className = 'message-row user';
        userMsgRow.innerHTML = `<div class="chat-bubble user">${message}</div>`;
        chatMessages.appendChild(userMsgRow);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        const loadingRow = document.createElement('div');
        loadingRow.className = 'message-row ai';
        loadingRow.id = 'loading-message';
        loadingRow.innerHTML = `<div class="chat-bubble ai">Réflexion en cours...</div>`;
        chatMessages.appendChild(loadingRow);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        try {
            const idToken = await auth.currentUser.getIdToken(true);
            const response = await fetch(CHAT_WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${idToken}` },
                body: JSON.stringify({ recordId: userRecord.id, message })
            });
            
            if (!response.ok) throw new Error(`Erreur serveur : ${response.status}`);
            
            const result = await response.json();
            const loadingMsg = document.getElementById('loading-message');
            if (loadingMsg) loadingMsg.remove();
            
            const aiMsgRow = document.createElement('div');
            aiMsgRow.className = 'message-row ai';
            aiMsgRow.innerHTML = `<div class="chat-bubble ai">${result.response || 'Réponse vide.'}</div>`;
            chatMessages.appendChild(aiMsgRow);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        } catch (error) {
            const loadingMsg = document.getElementById('loading-message');
            if (loadingMsg) loadingMsg.remove();
            
            const errorMsgRow = document.createElement('div');
            errorMsgRow.className = 'message-row ai';
            errorMsgRow.innerHTML = `<div class="chat-bubble ai" style="color: var(--danger-color);">Erreur : ${error.message}</div>`;
            chatMessages.appendChild(errorMsgRow);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }

    async function handleMakePresentation() {
        if (!userRecord) return;
        const isPremium = userRecord.fields['Premium Status'] === 'Premium';
        if (!isPremium) {
            showNotification('Fonctionnalité Premium', 'Cette fonctionnalité est réservée aux membres Premium.', 'error');
            return;
        }
        
        const lastDebrief = userRecord.fields['Debrief (from Debriefs)'];
        if (!lastDebrief || (Array.isArray(lastDebrief) && lastDebrief.length === 0)) {
            showNotification('Débrief manquant', 'Veuillez d\'abord générer un débrief avant de créer une présentation.', 'error');
            return;
        }
        
        const tempOverlay = document.getElementById('temp-loading-overlay');
        const tempMessage = document.getElementById('temp-loading-message');
        tempMessage.textContent = 'Création de la présentation en cours...';
        tempOverlay.classList.remove('hidden');
        
        try {
            const result = await callN8n('makePresentation', { recordId: userRecord.id });
            tempOverlay.classList.add('hidden');
            
            if (result.presentationHTML) {
                showPresentationModal(result.presentationHTML);
                await loadSavedPresentations();
            } else {
                showNotification('Erreur', 'Aucune présentation générée.', 'error');
            }
        } catch (error) {
            tempOverlay.classList.add('hidden');
            showNotification('Erreur', `Erreur lors de la création de la présentation : ${error.message}`, 'error');
        }
    }

    function updateZoom() {
        if (presentationIframe && presentationIframe.contentWindow && presentationIframe.contentWindow.document.body) {
            presentationIframe.contentWindow.document.body.style.transform = `scale(${currentScale})`;
            presentationIframe.contentWindow.document.body.style.transformOrigin = 'top left';
            presentationIframe.contentWindow.document.body.style.width = `${100 / currentScale}%`;
        }
    }

    async function downloadPresentation() {
        if (!presentationIframe) return;
        
        try {
            const iframeDoc = presentationIframe.contentWindow.document;
            const presentationHTML = iframeDoc.documentElement.outerHTML;
            
            const blob = new Blob([presentationHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'presentation-briova.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Téléchargement réussi', 'La présentation a été téléchargée.', 'success');
        } catch (error) {
            showNotification('Erreur', `Erreur lors du téléchargement : ${error.message}`, 'error');
        }
    }

    function showDashboard() {
        document.getElementById('loading-indicator').classList.add('hidden');
        document.getElementById('auth-section').classList.add('hidden');
        document.getElementById('dashboard-section').classList.remove('hidden');
        document.getElementById('main-header').classList.remove('hidden');
        
        updateSourcesTable();
        updateUIForSubscription();
        
        const debriefContent = document.getElementById('debrief-content');
        const debriefPlaceholder = document.getElementById('debrief-placeholder');
        const copyButton = document.getElementById('copy-debrief-button');
        
        const lastDebrief = userRecord.fields['Debrief (from Debriefs)'];
        
        if (lastDebrief && Array.isArray(lastDebrief) && lastDebrief.length > 0) {
            debriefContent.innerHTML = lastDebrief[0];
            debriefPlaceholder.classList.add('hidden');
            copyButton?.classList.remove('hidden');
        } else {
            debriefContent.innerHTML = '';
            debriefPlaceholder.classList.remove('hidden');
            copyButton?.classList.add('hidden');
        }
        
        const debriefRemaining = userRecord.fields['Debriefs Remaining'];
        if (debriefRemaining !== undefined) {
            document.getElementById('debriefs-remaining').textContent = `Débriefs restants : ${debriefRemaining}`;
        }
        
        const personaField = document.getElementById('user-persona-input');
        if (personaField && userRecord.fields['User Persona (AI)']) {
            personaField.value = userRecord.fields['User Persona (AI)'];
        }
        
        const formatSelector = document.getElementById('debrief-format-selector');
        if (formatSelector && userRecord.fields['Report Format']) {
            formatSelector.value = userRecord.fields['Report Format'];
        }
        
        loadSavedPresentations();
    }

    // ================================================================
    //  EVENT LISTENERS (TOUS 100% FONCTIONNELS)
    // ================================================================

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            firebaseUser = user;
            try {
                await getUserDataByEmail(user.email);
                
                const profileAvatar = document.getElementById('profile-avatar-initial');
                if (profileAvatar && user.email) {
                    profileAvatar.textContent = user.email.charAt(0).toUpperCase();
                }
                
                showDashboard();
            } catch (error) {
                if (error.message === "Utilisateur non trouvé.") {
                    await createUserData(user.email, user.displayName || 'Utilisateur');
                    await getUserDataByEmail(user.email);
                    showDashboard();
                } else {
                    showNotification('Erreur', error.message, 'error');
                    document.getElementById('loading-indicator').classList.add('hidden');
                    document.getElementById('auth-section').classList.remove('hidden');
                }
            }
        } else {
            document.getElementById('loading-indicator').classList.add('hidden');
            document.getElementById('auth-section').classList.remove('hidden');
        }
    });

    document.getElementById('login-button')?.addEventListener('click', async () => {
        const email = document.getElementById('auth-email').value.trim();
        const password = document.getElementById('auth-password').value.trim();
        const errorEl = document.getElementById('auth-error');
        const loginButton = document.getElementById('login-button');
        
        errorEl.classList.add('hidden');
        loginButton.disabled = true;
        loginButton.textContent = 'Connexion...';
        
        try {
            await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
            errorEl.textContent = error.message;
            errorEl.classList.remove('hidden');
            loginButton.disabled = false;
            loginButton.textContent = 'Se Connecter';
        }
    });

    document.getElementById('logout-button')?.addEventListener('click', async () => {
        await auth.signOut();
        location.reload();
    });

    // CORRECTION: Boutons signup et forgot password
    document.getElementById('show-signup-modal-button')?.addEventListener('click', () => {
        document.getElementById('signup-modal').classList.remove('hidden');
    });

    document.getElementById('close-signup-modal')?.addEventListener('click', () => {
        document.getElementById('signup-modal').classList.add('hidden');
    });

    document.getElementById('signup-button')?.addEventListener('click', async () => {
        const name = document.getElementById('signup-name').value.trim();
        const email = document.getElementById('signup-email').value.trim();
        const password = document.getElementById('signup-password').value.trim();
        const errorEl = document.getElementById('signup-error');
        const signupButton = document.getElementById('signup-button');
        
        errorEl.classList.add('hidden');
        
        if (!name || !email || !password) {
            errorEl.textContent = 'Veuillez remplir tous les champs.';
            errorEl.classList.remove('hidden');
            return;
        }
        
        signupButton.disabled = true;
        signupButton.textContent = 'Création...';
        
        try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            await userCredential.user.updateProfile({ displayName: name });
            await createUserData(email, name);
            
            document.getElementById('signup-modal').classList.add('hidden');
            document.getElementById('signup-success-modal').classList.remove('hidden');
        } catch (error) {
            errorEl.textContent = error.message;
            errorEl.classList.remove('hidden');
            signupButton.disabled = false;
            signupButton.textContent = 'Créer un compte';
        }
    });

    document.getElementById('close-signup-success-modal')?.addEventListener('click', () => {
        document.getElementById('signup-success-modal').classList.add('hidden');
    });

    document.getElementById('show-forgot-password-modal')?.addEventListener('click', () => {
        document.getElementById('forgot-password-modal').classList.remove('hidden');
    });

    document.getElementById('close-forgot-password-modal')?.addEventListener('click', () => {
        document.getElementById('forgot-password-modal').classList.add('hidden');
    });

    document.getElementById('send-reset-email-button')?.addEventListener('click', async () => {
        const email = document.getElementById('forgot-password-email').value.trim();
        const errorEl = document.getElementById('forgot-password-error');
        const resetButton = document.getElementById('send-reset-email-button');
        
        errorEl.classList.add('hidden');
        
        if (!email) {
            errorEl.textContent = 'Veuillez entrer votre adresse email.';
            errorEl.classList.remove('hidden');
            return;
        }
        
        resetButton.disabled = true;
        resetButton.textContent = 'Envoi...';
        
        try {
            await auth.sendPasswordResetEmail(email);
            showNotification('Email envoyé', 'Un email de réinitialisation a été envoyé à votre adresse.', 'success');
            document.getElementById('forgot-password-modal').classList.add('hidden');
            resetButton.disabled = false;
            resetButton.textContent = 'Envoyer le lien';
        } catch (error) {
            errorEl.textContent = error.message;
            errorEl.classList.remove('hidden');
            resetButton.disabled = false;
            resetButton.textContent = 'Envoyer le lien';
        }
    });

    document.getElementById('show-add-source-modal')?.addEventListener('click', () => {
        document.getElementById('add-source-modal').classList.remove('hidden');
    });

    document.getElementById('close-add-source-modal')?.addEventListener('click', () => {
        document.getElementById('add-source-modal').classList.add('hidden');
    });

    document.getElementById('website-launcher-btn')?.addEventListener('click', () => {
        document.getElementById('website-modal').classList.remove('hidden');
    });

    document.getElementById('youtube-launcher-btn')?.addEventListener('click', () => {
        document.getElementById('youtube-modal').classList.remove('hidden');
    });

    document.getElementById('podcast-launcher-btn')?.addEventListener('click', () => {
        document.getElementById('podcast-modal').classList.remove('hidden');
    });

    document.getElementById('text-launcher-btn')?.addEventListener('click', () => {
        const isPremium = userRecord?.fields['Premium Status'] === 'Premium';
        if (!isPremium) {
            showNotification('Fonctionnalité Premium', 'Cette fonctionnalité est réservée aux membres Premium.', 'error');
            return;
        }
        document.getElementById('text-modal').classList.remove('hidden');
    });

    document.querySelectorAll('.btn-close-sub-modal').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.target.closest('.modal-overlay')?.classList.add('hidden');
        });
    });

    document.getElementById('add-article-link-btn')?.addEventListener('click', () => {
        addLink('Article RSS Links', 'article-link-input');
        document.getElementById('website-modal').classList.add('hidden');
        document.getElementById('add-source-modal').classList.add('hidden');
    });

    document.getElementById('add-youtube-link-btn')?.addEventListener('click', () => {
        addLink('YouTube Links', 'youtube-link-input');
        document.getElementById('youtube-modal').classList.add('hidden');
        document.getElementById('add-source-modal').classList.add('hidden');
    });

    document.getElementById('add-podcast-btn')?.addEventListener('click', () => {
        addPodcast();
        document.getElementById('podcast-modal').classList.add('hidden');
        document.getElementById('add-source-modal').classList.add('hidden');
    });

    document.getElementById('start-debrief-button')?.addEventListener('click', startDebrief);

    document.getElementById('chat-form')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        if (message) {
            sendChatMessage(message);
            input.value = '';
        }
    });

    document.getElementById('profile-button')?.addEventListener('click', () => {
        const modal = document.getElementById('profile-modal');
        const nameField = document.getElementById('profile-name');
        const emailField = document.getElementById('profile-email');
        const modalUserName = document.getElementById('profile-modal-user-name');
        
        if (userRecord) {
            nameField.value = userRecord.fields.Name || '';
            emailField.value = userRecord.fields.Email || '';
            modalUserName.textContent = userRecord.fields.Name || 'Utilisateur';
        }
        
        modal.classList.remove('hidden');
    });

    document.getElementById('close-profile-modal')?.addEventListener('click', () => {
        document.getElementById('profile-modal').classList.add('hidden');
    });

    document.getElementById('profile-tab-btn')?.addEventListener('click', (e) => {
        e.preventDefault();
        showTab('profile');
    });

    document.getElementById('security-tab-btn')?.addEventListener('click', (e) => {
        e.preventDefault();
        showTab('security');
    });

    document.getElementById('plans-tab-btn')?.addEventListener('click', (e) => {
        e.preventDefault();
        showTab('plans');
    });

    document.getElementById('save-profile-button')?.addEventListener('click', async () => {
        const newName = document.getElementById('profile-name').value.trim();
        if (!newName || !userRecord) return;
        
        try {
            updateLocalUserRecord(await callN8n('updateProfile', { recordId: userRecord.id, name: newName }));
            showNotification('Profil mis à jour', 'Vos informations ont été sauvegardées.', 'success');
        } catch (error) {
            showNotification('Erreur', error.message, 'error');
        }
    });

    document.getElementById('update-password-button')?.addEventListener('click', async () => {
        const oldPassword = document.getElementById('security-old-password').value;
        const newPassword = document.getElementById('security-new-password').value;
        const confirmPassword = document.getElementById('security-confirm-password').value;
        
        if (newPassword !== confirmPassword) {
            showNotification('Erreur', 'Les mots de passe ne correspondent pas.', 'error');
            return;
        }
        
        try {
            const user = auth.currentUser;
            const credential = firebase.auth.EmailAuthProvider.credential(user.email, oldPassword);
            await user.reauthenticateWithCredential(credential);
            await user.updatePassword(newPassword);
            
            document.getElementById('security-old-password').value = '';
            document.getElementById('security-new-password').value = '';
            document.getElementById('security-confirm-password').value = '';
            
            showNotification('Succès', 'Votre mot de passe a été mis à jour.', 'success');
        } catch (error) {
            showNotification('Erreur', error.message, 'error');
        }
    });

    document.getElementById('plans-upgrade-button')?.addEventListener('click', async () => {
        showNotification('Upgrade Premium', 'Fonctionnalité de paiement à venir. Contactez le support.', 'success');
    });

    document.getElementById('plans-cancel-button')?.addEventListener('click', async () => {
        const confirmed = await showNotification('Annuler Premium ?', 'Êtes-vous sûr de vouloir annuler votre abonnement Premium ?', 'confirm');
        if (!confirmed) return;
        
        showNotification('Annulation', 'Votre abonnement sera annulé. Contactez le support pour finaliser.', 'success');
    });

    document.getElementById('settings-button')?.addEventListener('click', () => {
        const dropdown = document.getElementById('settings-dropdown');
        dropdown.classList.toggle('active');
    });

    document.addEventListener('click', (e) => {
        const settingsBtn = document.getElementById('settings-button');
        const dropdown = document.getElementById('settings-dropdown');
        if (dropdown && !dropdown.contains(e.target) && !settingsBtn.contains(e.target)) {
            dropdown.classList.remove('active');
        }
    });

    document.getElementById('make-presentation-btn')?.addEventListener('click', handleMakePresentation);

    document.getElementById('close-presentation-modal')?.addEventListener('click', () => {
        document.getElementById('presentation-modal').classList.add('hidden');
    });

    document.getElementById('zoom-in-btn')?.addEventListener('click', () => {
        if (currentScale < maxScale) {
            currentScale += zoomStep;
            updateZoom();
        }
    });

    document.getElementById('zoom-out-btn')?.addEventListener('click', () => {
        if (currentScale > minScale) {
            currentScale -= zoomStep;
            updateZoom();
        }
    });

    document.getElementById('download-presentation-btn')?.addEventListener('click', downloadPresentation);

    document.getElementById('copy-debrief-button')?.addEventListener('click', () => {
        const debriefContent = document.getElementById('debrief-content');
        const copyIcon = document.getElementById('copy-icon');
        const successIcon = document.getElementById('copy-success-icon');
        
        if (!debriefContent) return;
        
        const textToCopy = debriefContent.innerText || debriefContent.textContent;
        
        navigator.clipboard.writeText(textToCopy).then(() => {
            copyIcon.classList.add('hidden');
            successIcon.classList.remove('hidden');
            
            setTimeout(() => {
                copyIcon.classList.remove('hidden');
                successIcon.classList.add('hidden');
            }, 2000);
        }).catch(err => {
            showNotification('Erreur', 'Impossible de copier le texte.', 'error');
        });
    });

    // Mobile Navigation
    if (window.innerWidth <= 1024) {
        document.getElementById('mobile-nav').classList.remove('hidden');
        
        const mobileNavBtns = {
            sources: document.getElementById('mobile-nav-sources'),
            chat: document.getElementById('mobile-nav-chat'),
            studio: document.getElementById('mobile-nav-studio')
        };
        
        const panels = document.querySelectorAll('.main-grid > .panel');
        
        function switchMobileView(activeIndex) {
            panels.forEach((panel, idx) => {
                panel.classList.remove('mobile-active');
                if (idx === activeIndex) panel.classList.add('mobile-active');
            });
            
            Object.values(mobileNavBtns).forEach(btn => btn?.classList.remove('active'));
            Object.values(mobileNavBtns)[activeIndex]?.classList.add('active');
        }
        
        switchMobileView(1);
        
        mobileNavBtns.sources?.addEventListener('click', () => switchMobileView(0));
        mobileNavBtns.chat?.addEventListener('click', () => switchMobileView(1));
        mobileNavBtns.studio?.addEventListener('click', () => switchMobileView(2));
    }

    // PDF Upload
    document.getElementById('pdf-upload-area')?.addEventListener('click', () => {
        const isPremium = userRecord?.fields['Premium Status'] === 'Premium';
        if (!isPremium) {
            showNotification('Fonctionnalité Premium', 'L\'upload de PDF est réservé aux membres Premium.', 'error');
            return;
        }
        document.getElementById('pdf-file-input').click();
    });

    document.getElementById('pdf-file-input')?.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        if (file.type !== 'application/pdf') {
            showNotification('Format invalide', 'Seuls les fichiers PDF sont acceptés.', 'error');
            return;
        }
        
        const tempOverlay = document.getElementById('temp-loading-overlay');
        const tempMessage = document.getElementById('temp-loading-message');
        tempMessage.textContent = 'Upload du PDF en cours...';
        tempOverlay.classList.remove('hidden');
        
        try {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('recordId', userRecord.id);
            
            const idToken = await auth.currentUser.getIdToken(true);
            const response = await fetch('https://n8n.brieova.com/webhook/upload-pdf', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${idToken}` },
                body: formData
            });
            
            if (!response.ok) throw new Error(`Erreur d'upload: ${response.status}`);
            
            const result = await response.json();
            updateLocalUserRecord(result);
            
            tempOverlay.classList.add('hidden');
            document.getElementById('add-source-modal').classList.add('hidden');
            showDashboard();
            showNotification('Succès', 'PDF uploadé avec succès !', 'success');
        } catch (error) {
            tempOverlay.classList.add('hidden');
            showNotification('Erreur', `Erreur lors de l'upload : ${error.message}`, 'error');
        }
        
        e.target.value = '';
    });
    </script>
</body>
</html>



    
