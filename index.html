<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Votre Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
    header { background: #2c3e50; color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
    header h1 { margin: 0; font-size: 1.2rem; }
    header nav a { color: white; margin-left: 1rem; text-decoration: none; }
    .container { padding: 2rem; }
    .section { background: white; padding: 1rem; margin-bottom: 1rem; border-radius: 6px; }
    .section h2 { margin-top: 0; }
    input[type="text"] { width: 80%; padding: 0.5rem; margin-right: 0.5rem; }
    button { padding: 0.5rem 1rem; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #2980b9; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ddd; padding: 0.5rem; text-align: left; }
    th { background: #f0f0f0; }
    #notification-modal { position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; padding: 1rem; border-radius: 6px; display: none; }
  </style>
</head>
<body>
  <header>
    <h1>Votre Dashboard</h1>
    <nav>
      <a href="#">Home</a>
      <a href="#">Profil</a>
      <a href="#" id="logout" style="color:red;">Déconnexion</a>
    </nav>
  </header>

  <div class="container" id="dashboard" style="display:none;">
    <div class="section">
      <h2>Articles / Liens RSS</h2>
      <input type="text" id="rssInput" placeholder="Collez vos liens RSS séparés par des virgules">
      <button onclick="addLink('RSS', 'rssInput')">Ajouter</button>
    </div>

    <div class="section">
      <h2>Vidéos YouTube</h2>
      <input type="text" id="ytInput" placeholder="Collez vos liens YouTube séparés par des virgules">
      <button onclick="addLink('YouTube', 'ytInput')">Ajouter</button>
    </div>

    <div class="section">
      <h2>Podcasts</h2>
      <input type="text" id="podcastInput" placeholder="Collez vos liens Podcasts séparés par des virgules">
      <button onclick="addLink('Podcasts', 'podcastInput')">Ajouter</button>
    </div>

    <div class="section">
      <h2>Vos Sources Actuelles</h2>
      <table id="sourcesTable">
        <thead>
          <tr>
            <th>Type</th>
            <th>Liens</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section">
      <h2>Débrief</h2>
      <p>Débriefs restants : <span id="debriefCount">-</span></p>
      <p>Statut : <span id="userStatus">-</span></p>
      <button onclick="startDebrief()">Lancer le Débrief</button>
    </div>
  </div>

  <div id="notification-modal">Débrief lancé avec succès !</div>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
  <script>
    // --- CONFIG FIREBASE ---
    const firebaseConfig = {
      apiKey: "TON_API_KEY_FIREBASE",
      authDomain: "TON_PROJET.firebaseapp.com",
      projectId: "TON_PROJET",
      storageBucket: "TON_PROJET.appspot.com",
      messagingSenderId: "XXX",
      appId: "XXX"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // --- CONFIG N8N ---
    const N8N_ENDPOINT = "https://n8n.brieova.com/webhook/user-actions";
    let userRecord = null;

    async function callN8N(action, payload = {}) {
      const response = await fetch(N8N_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action, ...payload })
      });
      if (!response.ok) throw new Error("Erreur serveur n8n");
      return await response.json();
    }

    async function findUserRecordByEmail(email) {
      const user = await callN8N("findUserByEmail", { email });
      userRecord = user;
      updateSourcesTable();
      updateUsageLimit();
      return user;
    }

    async function addLink(fieldName, inputId) {
      if (!userRecord) return;
      const inputElement = document.getElementById(inputId);
      const newLinks = inputElement.value.trim();
      if (!newLinks) return;

      const existingLinks = userRecord.fields[fieldName] ? String(userRecord.fields[fieldName]).split(",").filter(Boolean) : [];
      const newLinksArray = newLinks.split(",").map(s => s.trim()).filter(Boolean);
      const allLinks = [...new Set([...existingLinks, ...newLinksArray])].join(",");

      const updated = await callN8N("addLink", {
        recordId: userRecord.id,
        fieldName,
        allLinks
      });

      userRecord = updated;
      inputElement.value = "";
      updateSourcesTable();
    }

    async function clearLinks(fieldName) {
      if (!userRecord) return;
      const updated = await callN8N("clearLinks", {
        recordId: userRecord.id,
        fieldName
      });
      userRecord = updated;
      updateSourcesTable();
    }

    async function startDebrief() {
      if (!userRecord) return;
      const updated = await callN8N("startDebrief", {
        recordId: userRecord.id
      });
      userRecord = updated;
      updateUsageLimit();
      const modal = document.getElementById("notification-modal");
      modal.style.display = "block";
      setTimeout(() => { modal.style.display = "none"; }, 4000);
    }

    function updateSourcesTable() {
      const tbody = document.querySelector("#sourcesTable tbody");
      tbody.innerHTML = "";
      if (!userRecord || !userRecord.fields) return;
      ["RSS", "YouTube", "Podcasts"].forEach(type => {
        const links = userRecord.fields[type] || "";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${type}</td>
          <td>${links}</td>
          <td><button onclick="clearLinks('${type}')">Vider</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function updateUsageLimit() {
      if (!userRecord || !userRecord.fields) return;
      document.getElementById("debriefCount").innerText = userRecord.fields["Debriefs Restants"] || 0;
      document.getElementById("userStatus").innerText = userRecord.fields["Statut"] || "-";
    }

    // --- AUTH ---
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        await findUserRecordByEmail(user.email);
        document.getElementById("dashboard").style.display = "block";
      } else {
        document.getElementById("dashboard").style.display = "none";
      }
    });

    document.getElementById("logout").addEventListener("click", () => {
      auth.signOut();
    });
  </script>
</body>
</html>
