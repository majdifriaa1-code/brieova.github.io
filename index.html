<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRIOVA - Votre Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .container { max-width: 800px; margin: 0 auto; padding: 2rem; }
        .card { background-color: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 2.5rem; margin-bottom: 2rem; }
        .input-field { border: 1px solid #e2e8f0; border-radius: 8px; padding: 0.75rem 1rem; width: 100%; transition: all 0.2s ease-in-out; background-color: #f1f5f9; }
        .input-field:focus { outline: none; border-color: #4a90e2; box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2); background-color: white; }
        .btn { border-radius: 9999px; padding: 0.75rem 1.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease-in-out; white-space: nowrap; width: 100%; }
        .btn:disabled { background-color: #cbd5e0; cursor: not-allowed; }
        .btn-primary { background-color: #4a90e2; color: white; box-shadow: 0 4px 14px rgba(0,0,0,0.1); }
        .btn-primary:hover { background-color: #357abd; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
        .btn-secondary { background-color: #e2e8f0; color: #4a5568; }
        .btn-secondary:hover { background-color: #cbd5e0; }
        .table-cell { padding: 1rem; border-bottom: 1px solid #edf2f7; vertical-align: top; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 16px; text-align: center; max-width: 500px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .user-panel { background-color: white; border-radius: 16px; padding: 1rem; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .user-panel a, .user-panel button { display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: #4a5568; text-decoration: none; padding: 0.5rem 1rem; border-radius: 9999px; transition: all 0.2s ease-in-out; background-color: transparent; border: 1px solid #e2e8f0; }
        .user-panel a:hover, .user-panel button:hover { background-color: #f1f5f9; border-color: #cbd5e0; }
        .user-panel .btn-primary { background-color: #4a90e2; color: white; border: none; }
        .user-panel .btn-primary:hover { background-color: #357abd; }
        .user-panel .btn-danger { background-color: #ef4444; color: white; border: none; }
        .user-panel .btn-danger:hover { background-color: #dc2626; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .loader { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #ffffff; z-index: 100; align-items: center; justify-content: center; }
        .loader-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4a90e2; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 768px) {
            .container { max-width: 100%; padding: 1rem; }
            .card { padding: 1.5rem; margin-bottom: 1rem; }
            .input-field { padding: 0.5rem 0.75rem; }
            .btn { padding: 0.5rem 1rem; font-size: 0.875rem; }
            .flex.items-center.justify-between { flex-direction: column; gap: 1rem; text-align: center; }
            .user-panel { flex-wrap: wrap; justify-content: center; gap: 0.5rem; padding: 0.5rem; }
            .user-panel a, .user-panel button { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
            .table-cell { padding: 0.5rem; font-size: 0.875rem; }
            table { display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .modal-content { padding: 1.5rem; margin: 1rem; }
            .loader-spinner { width: 30px; height: 30px; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="loading-indicator" class="loader">
        <div class="loader-spinner"></div>
    </div>
    <div id="app" class="container">
        <div id="auth-section" class="flex items-center justify-center min-h-screen hidden">
            <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-2xl shadow-lg">
                <div class="text-center">
                    <img src="https://cdn.prod.website-files.com/68b9f8920957ffd144ee6dd0/68d2e687122a4d05e0c8b291_Logo%20site%20web%20horiz.png" alt="Brieova Logo" class="h-12 mx-auto">
                </div>
                <h2 class="text-2xl font-bold text-center text-gray-800">Se connecter à BRIOVA</h2>
                <div class="space-y-6">
                    <div>
                        <label for="auth-email" class="block text-sm font-medium text-gray-700">Adresse email</label>
                        <input type="email" id="auth-email" placeholder="Entrez votre adresse email" class="w-full px-4 py-3 mt-1 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="auth-password" class="block text-sm font-medium text-gray-700">Mot de passe</label>
                        <input type="password" id="auth-password" placeholder="Entrez votre mot de passe" class="w-full px-4 py-3 mt-1 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <p id="auth-error" class="text-sm text-red-500 hidden"></p>
                    <button id="login-button" class="w-full px-4 py-3 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Se Connecter</button>
                    <button id="show-signup-modal-button" class="w-full px-4 py-3 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">Créer un compte</button>
                    <div class="text-center mt-4">
                        <button id="show-forgot-password-modal" class="text-sm text-blue-600 hover:text-blue-800 hover:underline focus:outline-none">
                            Mot de passe oublié ?
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="signup-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <h3 class="text-2xl font-bold text-center text-gray-800 mb-6">Créer votre compte BRIOVA</h3>
                <div class="space-y-6">
                    <div>
                        <label for="signup-modal-email" class="block text-sm font-medium text-gray-700">Adresse email</label>
                        <input type="email" id="signup-modal-email" placeholder="Adresse email" class="w-full px-4 py-3 mt-1 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                       <label for="signup-modal-name" class="block text-sm font-medium text-gray-700">Nom</label>
                       <input type="text" id="signup-modal-name" placeholder="Entrez votre nom" class="w-full px-4 py-3 mt-1 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                   </div>
                    <div>
                        <label for="signup-modal-password" class="block text-sm font-medium text-gray-700">Mot de passe</label>
                        <input type="password" id="signup-modal-password" placeholder="Mot de passe" class="w-full px-4 py-3 mt-1 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="signup-modal-password-confirm" class="block text-sm font-medium text-gray-700">Confirmez le mot de passe</label>
                        <input type="password" id="signup-modal-password-confirm" placeholder="Confirmez le mot de passe" class="w-full px-4 py-3 mt-1 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <p id="signup-modal-error" class="text-sm text-red-500 hidden"></p>
                    <div class="flex space-x-4">
                        <button id="signup-modal-cancel" class="flex-1 px-4 py-3 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">Annuler</button>
                        <button id="signup-modal-submit" class="flex-1 px-4 py-3 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Créer mon compte</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="signup-success-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <svg class="w-16 h-16 mx-auto text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                <h3 class="text-2xl font-bold text-gray-800 mt-4">Félicitations !</h3>
                <p class="text-gray-600 mt-2">Votre compte a été créé avec succès.</p>
                <p class="text-gray-600 mt-2">Vous allez recevoir un email de confirmation.</p>
                <button id="signup-success-login-button" class="w-full px-4 py-3 mt-6 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Se Connecter</button>
            </div>
        </div>
        <div id="forgot-password-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <h3 class="text-2xl font-bold text-center text-gray-800">Réinitialiser votre mot de passe</h3>
                <p class="text-gray-600 text-center">Entrez votre adresse email pour recevoir un lien de réinitialisation.</p>
                <div class="space-y-6 mt-6">
                    <div>
                        <label for="forgot-password-email" class="block text-sm font-medium text-gray-700">Adresse email</label>
                        <input type="email" id="forgot-password-email" placeholder="Entrez votre adresse email" class="w-full px-4 py-3 mt-1 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <p id="forgot-password-error" class="text-sm text-red-500 hidden"></p>
                    <p id="forgot-password-success" class="text-sm text-green-500 hidden"></p>
                    <div class="flex space-x-4">
                        <button id="forgot-password-cancel" class="flex-1 px-4 py-3 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">Annuler</button>
                        <button id="forgot-password-submit" class="flex-1 px-4 py-3 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Envoyer le lien</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="dashboard-section" class="hidden">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4">
                <div class="flex flex-col md:flex-row md:items-center gap-4">
                    <div class="flex-shrink-0">
                        <img src="https://cdn.prod.website-files.com/68b9f8920957ffd144ee6dd0/68d2e687122a4d05e0c8b291_Logo%20site%20web%20horiz.png" alt="Brieova Logo" class="h-10 md:h-12 w-auto">
                    </div>
                    <div class="flex flex-col items-center md:items-start text-center md:text-left">
                        <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Votre Dashboard</h2>
                        <span id="user-display-name" class="font-medium text-gray-600 text-sm md:text-base"></span>
                    </div>
                </div>
                <div class="user-panel">
                    <a href="https://dashboard.brieova.com" target="_blank" class="flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v6m3-2a3 3 0 110-6v6zm5-2a3 3 0 110-6v6z" /></svg> Home
                    </a>
                    <button id="open-profile-modal" class="flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg> Profil
                    </button>
                    <div id="user-status" class="status-badge bg-gray-100 text-gray-800"></div>
                    <div id="debriefs-remaining" class="status-badge bg-green-100 text-green-800"></div>
                  <button id="upgrade-button" class="btn btn-primary hidden">Passer Premium</button>
<button id="cancel-premium-button" class="btn btn-danger hidden">Annuler l'abonnement</button>
                    <button id="logout-button" class="btn-danger flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 6v-6" /></svg> Déconnexion
                    </button>
                </div>
            </div>
<div class="card">
    <h3 class="text-xl font-semibold text-gray-700 mb-2">Décrivez votre profil pour l'IA</h3>
    <p class="text-sm text-gray-600 mb-4">
        Please describe, in your native language, your job or personality in relation to the type of sources, to help the AI improve its summarization. If you don’t have a specific job, just write 'Normal person' and then confirm your choice.
    </p>
    <p class="text-xs text-gray-400 mb-4">
        Exemple : "Profile focused on AI-driven digital marketing and growth tools, intermediate-to-advanced expertise, suggested segmentation"
    </p>
    
    <div class="flex flex-col md:flex-row md:space-x-2 gap-2">
        <textarea id="user-persona-input" rows="3" class="input-field flex-grow" placeholder="Écrivez votre description ici..."></textarea>
        <button onclick="saveUserPersona()" class="btn btn-secondary w-full md:w-auto">Valider</button>
    </div>
</div>
         
            <div class="card">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Articles / Liens RSS</h3>
                <div class="flex space-x-2">
                    <input type="url" id="article-link-input" placeholder="Collez vos liens (séparés par une virgule)" class="input-field flex-grow">
                    <button onclick="addLink('Article RSS Links', 'article-link-input')" class="btn btn-secondary">Ajouter</button>
                </div>
            </div>
            <div class="card">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Vidéos YouTube</h3>
                <div class="flex space-x-2">
                    <input type="url" id="youtube-link-input" placeholder="Collez vos liens (séparés par une virgule)" class="input-field flex-grow">
                    <button onclick="addLink('YouTube Links', 'youtube-link-input')" class="btn btn-secondary">Ajouter</button>
                </div>
            </div>
            <div class="card">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Podcasts</h3>
                <div class="flex flex-col md:flex-row md:space-x-2 gap-2">
                    <input type="url" id="podcast-link-input" placeholder="Collez le lien du podcast" class="input-field flex-grow">
                    <input type="text" id="podcast-title-input" placeholder="Entrez le titre du podcast" class="input-field flex-grow">
                    <button onclick="addPodcast()" class="btn btn-secondary">Ajouter</button>
                </div>
            </div>

<div class="card bg-blue-50 border border-blue-200 shadow-md">
    <div class="flex items-start gap-4">
        <div class="flex-shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        </div>
        <div>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">How to add a Spotify podcast?</h3>
            <p class="text-sm text-gray-700 mb-3">To add a Spotify podcast, please follow these 2 rules: :</p>
            <ul class="list-disc list-inside space-y-2 text-sm text-gray-600">
                <li>Add the link of the podcast channel in the tool below, then click Find RSS Feed. Copy the generated link and paste it into our Podcast Link field".</li>
                <li>Use the exact same name of the podcast episode as it appears on Spotify. If you do not use the correct name, the debriefing system will not recognize the podcast as a source. Please enter the episode name in the designated field.</li>
                <li>Note: Not all Spotify podcasts have publicly available RSS feeds.This tool attempts to find RSS feeds when available.</li>
            </ul>
        </div>
    </div>
</div>

<div class="card">
    <h3 class="text-xl font-semibold text-gray-700 mb-4">RSS Feed Finder Tool</h3>
    <div class="w-full h-[400px] border border-gray-200 rounded-lg overflow-hidden">
        <iframe 
            src="https://www.get-rss.com/" 
            class="w-full h-full" 
            style="border:0;" 
            allowfullscreen="" 
            loading="lazy" 
            title="Outil Get RSS">
        </iframe>
    </div>
</div>



            
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Vos Sources Actuelles</h2>
                <table class="w-full text-left">
                    <thead><tr><th class="table-cell font-semibold text-gray-600">Type</th><th class="table-cell font-semibold text-gray-600">Liens</th><th class="table-cell font-semibold text-gray-600">Actions</th></tr></thead>
                    <tbody id="sources-table"></tbody>
                </table>
            </div>
            <div class="text-center">
                <button id="start-debrief-button" class="btn btn-primary text-lg">Start the Debrief</button>
                <p id="usage-limit" class="text-gray-500 text-sm mt-4"></p>
            </div>
        
        </div> </div>
    <div id="notification-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <svg class="mx-auto mb-4 w-12 h-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <h3 class="text-xl font-semibold text-gray-800">Votre débrief est en cours !</h3>
            <p class="text-gray-600 mt-2">Vous recevrez la synthèse dans quelques minutes sur votre boîte mail.</p>
        </div>
    </div>
    <div id="profile-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-start mb-6">
                <h3 class="text-2xl font-semibold text-gray-800">Informations du Profil</h3>
                <button id="close-profile-modal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="space-y-6">
                <div>
                    <label for="profile-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="profile-email" class="input-field mt-1 w-full" readonly>
                </div>
                <div>
                    <label for="profile-password" class="block text-sm font-medium text-gray-700">Nouveau Mot de Passe</label>
                    <input type="password" id="profile-password" placeholder="Entrez un nouveau mot de passe" class="input-field mt-1 w-full">
                </div>
                <div>
                    <label for="profile-password-confirm" class="block text-sm font-medium text-gray-700">Confirmer le Mot de Passe</label>
                    <input type="password" id="profile-password-confirm" placeholder="Confirmez le nouveau mot de passe" class="input-field mt-1 w-full">
                </div>
                <p id="profile-error" class="text-sm text-red-500 hidden"></p>
                <div class="flex space-x-4">
                    <button id="save-profile-button" class="flex-1 px-4 py-3 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Enregistrer</button>
                    <button id="cancel-profile-button" class="flex-1 px-4 py-3 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">Annuler</button>
                </div>
            </div>
        </div>
    </div>
<script>
    // --- CONFIGURATION FIREBASE ---
    const firebaseConfig = {
       apiKey: "AIzaSyBxt3psNIY8yFbzmSUURXK_Ne5jnagbZTQ",
       authDomain: "brieova-f3288.firebaseapp.com",
       projectId: "brieova-f3288",
       storageBucket: "brieova-f3288.appspot.com",
       messagingSenderId: "931818128414",
       appId: "1:931818128414:web:8ee00d3f3bfd5fc9f21a0f"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch((error) => console.error("Erreur persistance :", error));
    
    // --- CONFIGURATION N8N ---
    const USER_ACTIONS_WEBHOOK_URL = 'https://n8n.brieova.com/webhook/user-actions';

    // --- VARIABLES GLOBALES ---
    let userRecord = null;
    let firebaseUser = null;
    let isProcessingAuth = false;

    // --- FONCTIONS DE COMMUNICATION N8N ---
    async function callN8n(action, data = {}) {
        try {
            if (!auth.currentUser) throw new Error("Utilisateur non authentifié.");
            const idToken = await auth.currentUser.getIdToken();
            const response = await fetch(USER_ACTIONS_WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${idToken}` },
                body: JSON.stringify({ action, ...data })
            });
            if (!response.ok) throw new Error(`Le serveur a refusé la requête : ${response.status}`);
            return await response.json();
        } catch (error) {
            console.error("Erreur lors de l'appel sécurisé au webhook:", error);
            throw new Error("Une erreur réseau ou serveur est survenue.");
        }
    }
    
    // --- FONCTIONS DE GESTION DES DONNÉES UTILISATEUR ---
    function updateLocalUserRecord(recordFromN8n) {
        let potentialRecord = Array.isArray(recordFromN8n) && recordFromN8n.length > 0 ? recordFromN8n[0] : recordFromN8n;
        if (!potentialRecord || typeof potentialRecord !== 'object' || !potentialRecord.id) {
             console.error("Tentative de mise à jour avec une réponse invalide de n8n:", potentialRecord);
             return;
        }
        if (potentialRecord.fields) {
            userRecord = potentialRecord;
        } else {
            const { id, createdTime, ...fields } = potentialRecord;
            userRecord = { id, createdTime, fields };
        }
    }

    async function getUserDataByEmail(email) {
        const rawResult = await callN8n('findUser', { email });
        updateLocalUserRecord(rawResult);
        if (!userRecord) {
            throw new Error("Utilisateur non trouvé ou format de données invalide.");
        }
    }
    
    async function createUserData(email, name) {
        const newUserRecord = await callN8n('createUser', { email: email, name: name });
        if (!newUserRecord || !newUserRecord.id) throw new Error("La création du profil a échoué.");
    }

    // --- FONCTIONS DU DASHBOARD ---
async function addLink(fieldName, inputId) {
    if (!userRecord) return;
    const inputElement = document.getElementById(inputId);
    const newLinks = inputElement.value.trim();
    if (!newLinks) return;

    // --- VALIDATION YOUTUBE (INCHANGÉE ET CORRECTE) ---
    if (fieldName === 'YouTube Links') {
        const youtubeRegex = /^(https?:\/\/)?((www|m)\.)?(youtube\.com|youtu\.be)\/.+$/;
        const linksToTest = newLinks.split(',').map(s => s.trim()).filter(Boolean);
        const allLinksAreValid = linksToTest.every(link => youtubeRegex.test(link));

        if (!allLinksAreValid) {
            alert("Veuillez n'entrer que des liens YouTube valides, séparés par une virgule.");
            return;
        }
    }
    // --- FIN DE LA VALIDATION YOUTUBE ---

    const existingLinks = userRecord.fields[fieldName] ? String(userRecord.fields[fieldName]).split(',').filter(Boolean) : [];
    const newLinksArray = newLinks.split(',').map(s => s.trim()).filter(Boolean);
    
    // CORRECTION : Remplacement de "existing-links" par "existingLinks"
    const allLinks = [...new Set([...existingLinks, ...newLinksArray])].join(',');

    try {
        const updatedRecord = await callN8n('addLink', { recordId: userRecord.id, fieldName: fieldName, allLinks: allLinks });
        updateLocalUserRecord(updatedRecord);
        inputElement.value = '';
        showDashboard();
    } catch (error) {
        alert("Impossible de sauvegarder le lien: " + error.message);
    }
}

    async function saveUserPersona() {
    if (!userRecord) return;
    const personaText = document.getElementById('user-persona-input').value.trim();

    try {
        const updatedRecord = await callN8n('updateUserPersona', {
            recordId: userRecord.id,
            personaText: personaText
        });
        updateLocalUserRecord(updatedRecord);
        alert("Profil enregistré avec succès !"); // Notification simple
        showDashboard(); // Rafraîchit l'affichage
    } catch (error) {
        alert("Erreur lors de la sauvegarde du profil : " + error.message);
    }
}

    
    async function addPodcast() {
        if (!userRecord) return;
        const newLink = document.getElementById('podcast-link-input').value.trim();
        const newTitle = document.getElementById('podcast-title-input').value.trim();
        if (!newLink) {
            alert("Veuillez remplir au moins le lien du podcast.");
            return;
        }
        let podcasts = [];
        try {
            podcasts = JSON.parse(userRecord.fields['Podcast RSS Links'] || '[]');
        } catch (e) {
            podcasts = [];
        }
        podcasts.push({ link: newLink, title: newTitle });
        try {
            const updatedRecord = await callN8n('updatePodcasts', {
                recordId: userRecord.id,
                podcastData: JSON.stringify(podcasts)
            });
            updateLocalUserRecord(updatedRecord);
            document.getElementById('podcast-link-input').value = '';
            document.getElementById('podcast-title-input').value = '';
            showDashboard();
        } catch (error) {
            alert("Impossible de sauvegarder le podcast. Erreur : " + error.message);
        }
    }

    // CORRECTION : Logique de la fonction clearLinks
    async function clearLinks(fieldName) {
        if (!userRecord) return;
        try {
            const updatedRecord = await callN8n('clearLinks', {
                recordId: userRecord.id,
                fieldName: fieldName
            });
            updateLocalUserRecord(updatedRecord);
            showDashboard();
        } catch (error) {
            alert("Impossible de vider les liens. Erreur : " + error.message);
        }
    }

    async function clearPodcast() {
        if (!userRecord) return;
        try {
            const updatedRecord = await callN8n('updatePodcasts', {
                recordId: userRecord.id,
                podcastData: '[]' 
            });
            updateLocalUserRecord(updatedRecord);
            showDashboard();
        } catch (error) {
            alert("Impossible de vider les podcasts. Erreur : " + error.message);
        }
    }

  async function startDebrief() {
    if (!userRecord) return;

    // --- AJOUT : Vérification du champ de profil ---
    const personaText = userRecord.fields['User Persona (AI)'] || '';
    if (personaText.trim() === '') {
        alert("Veuillez décrire votre profil dans le champ prévu à cet effet avant de lancer un débrief.");
        return; // On arrête la fonction
    }
    // --- FIN DE L'AJOUT ---

    const hasLinks = userRecord.fields['Article RSS Links'] || userRecord.fields['YouTube Links'] || (userRecord.fields['Podcast RSS Links'] && userRecord.fields['Podcast RSS Links'] !== '[]');
    if (!hasLinks) {
        alert("Vous devez ajouter au moins un lien avant de lancer le débrief.");
        return;
    }
    const debriefButton = document.getElementById('start-debrief-button');
    debriefButton.disabled = true;
    debriefButton.textContent = 'En cours...';
    try {
        const updatedRecord = await callN8n('startDebrief', { recordId: userRecord.id });
        updateLocalUserRecord(updatedRecord);
        showDashboard();
        document.getElementById('notification-modal').classList.remove('hidden');
        setTimeout(() => document.getElementById('notification-modal').classList.add('hidden'), 5000);
    } catch (error) {
        alert("Erreur lors du lancement du débrief: " + error.message);
    }
}

    // --- FONCTIONS D'AFFICHAGE ---
function showDashboard() {
    if (!userRecord || !userRecord.fields || !firebaseUser) { handleLogout(); return; }
    document.getElementById('auth-section').classList.add('hidden');
    document.getElementById('dashboard-section').classList.remove('hidden');

    const displayName = userRecord.fields.Name || firebaseUser.email;
    document.getElementById('user-display-name').textContent = displayName;

    const userStatusElement = document.getElementById('user-status');
    const status = userRecord.fields.Status || 'Free'; // J'ai remplacé 'Inconnu' par 'Free' par défaut
    let statusColorClass = 'bg-gray-100 text-gray-800';
    if (status === 'Premium') { statusColorClass = 'bg-yellow-100 text-yellow-800'; }
    userStatusElement.className = `status-badge ${statusColorClass}`;
    userStatusElement.textContent = status;

    const debriefsRemainingElement = document.getElementById('debriefs-remaining');
    const remaining = parseInt(userRecord.fields['Debriefs Restants']) || 0;
    let debriefsColorClass = 'bg-green-100 text-green-800';
    if (remaining <= 0) { debriefsColorClass = 'bg-red-100 text-red-800'; } 
    else if (remaining <= 2) { debriefsColorClass = 'bg-yellow-100 text-yellow-800'; }
    debriefsRemainingElement.className = `status-badge ${debriefsColorClass}`;
    debriefsRemainingElement.textContent = `Debriefs: ${remaining}`;
    
    const persona = userRecord.fields['User Persona (AI)'] || '';
    document.getElementById('user-persona-input').value = persona;

    updateSourcesTable();
    updateUsageLimit();

    // --- BLOC DE CODE MANQUANT À RAJOUTER ---
    // Cette partie gère l'affichage des boutons d'abonnement
    const upgradeButton = document.getElementById('upgrade-button');
    const cancelButton = document.getElementById('cancel-premium-button');

    if (status === 'Premium') {
        // Si l'utilisateur est Premium, on affiche le bouton d'annulation
        upgradeButton.classList.add('hidden');
        cancelButton.classList.remove('hidden');
    } else {
        // Sinon (s'il est "Free"), on affiche le bouton de mise à niveau
        upgradeButton.classList.remove('hidden');
        cancelButton.classList.add('hidden');
    }
    // --- FIN DU BLOC MANQUANT ---
}

    function updateSourcesTable() {
        if (!userRecord || !userRecord.fields) return;
        const tableBody = document.getElementById('sources-table');
        tableBody.innerHTML = '';
        const fieldsToShow = ['Article RSS Links', 'YouTube Links', 'Podcast RSS Links'];
        fieldsToShow.forEach(fieldName => {
            const row = document.createElement('tr');
            let linksHtml = '';
            let actionButtonHtml = '';
            if (fieldName === 'Podcast RSS Links') {
                let podcasts = [];
                try {
                    podcasts = JSON.parse(userRecord.fields[fieldName] || '[]');
                } catch (e) { /* Gère les données si elles sont invalides */ }
                linksHtml = `<span class="font-medium text-gray-600">${podcasts.length} podcast(s) ajouté(s)</span>`;
                if (podcasts.length > 0) {
                    linksHtml += '<div class="mt-2 text-xs text-gray-400 space-y-2 break-all">';
                    podcasts.forEach(p => {
                        linksHtml += `<div>
                                        <span class="font-semibold">${p.title || 'Sans titre'}</span><br/>
                                        <span>${p.link}</span>
                                     </div>`;
                    });
                    linksHtml += '</div>';
                }
                actionButtonHtml = `<button onclick="clearPodcast()" class="btn btn-secondary text-sm">Vider</button>`;
            } else {
                const linksArray = userRecord.fields[fieldName] ? String(userRecord.fields[fieldName]).split(',').filter(Boolean) : [];
                linksHtml = `<span class="font-medium text-gray-600">${linksArray.length} lien(s) ajouté(s)</span>`;
                if (linksArray.length > 0) {
                    linksHtml += '<div class="mt-2 text-xs text-gray-400 space-y-1 break-all">';
                    linksArray.forEach(link => { linksHtml += `<span>${link}</span><br/>`; });
                    linksHtml += '</div>';
                }
                actionButtonHtml = `<button onclick="clearLinks('${fieldName}')" class="btn btn-secondary text-sm">Vider</button>`;
            }
            row.innerHTML = `<td class="table-cell font-semibold">${fieldName.replace('Links', '').replace('RSS', '')}</td><td class="table-cell">${linksHtml}</td><td class="table-cell">${actionButtonHtml}</td>`;
            tableBody.appendChild(row);
        });
    }
    
    function updateUsageLimit() {
        if (!userRecord || !userRecord.fields) return;
        const usageElement = document.getElementById('usage-limit');
        const debriefButton = document.getElementById('start-debrief-button');
        const debriefsRemaining = parseInt(userRecord.fields['Debriefs Restants']) || 0;
        if (userRecord.fields.Status === 'Free' || !userRecord.fields.Status) {
            usageElement.textContent = `Offre Gratuite : Il vous reste ${debriefsRemaining} débrief(s).`;
            debriefButton.disabled = debriefsRemaining <= 0;
            debriefButton.textContent = debriefsRemaining <= 0 ? 'Limite atteinte' : 'Lancer le Débrief';
        } else {
            usageElement.textContent = `Plan ${userRecord.fields.Status} : Profitez de débriefs illimités !`;
            debriefButton.disabled = false;
            debriefButton.textContent = 'Lancer le Débrief';
        }
    }

    async function handleLogout() {
        await auth.signOut();
        firebaseUser = null;
        userRecord = null;
        document.getElementById('auth-section').classList.remove('hidden');
        document.getElementById('dashboard-section').classList.add('hidden');
    }
    
    // --- GESTION DE L'ÉTAT ET ÉVÉNEMENTS ---
    auth.onAuthStateChanged(async (user) => {
        if (isProcessingAuth) return;
        const loadingIndicator = document.getElementById('loading-indicator');
        loadingIndicator.classList.remove('hidden');
        if (user) {
            firebaseUser = user;
            try {
                await getUserDataByEmail(user.email);
                showDashboard();
            } catch (error) { await handleLogout(); }
        } else {
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('dashboard-section').classList.add('hidden');
        }
        loadingIndicator.classList.add('hidden');
    });

    // Écouteurs d'événements pour l'authentification
    document.getElementById('login-button').addEventListener('click', async () => {
        const email = document.getElementById('auth-email').value.trim();
        const password = document.getElementById('auth-password').value.trim();
        const errorElement = document.getElementById('auth-error');
        const loginButton = document.getElementById('login-button');
        errorElement.classList.add('hidden');
        loginButton.disabled = true;
        isProcessingAuth = true;
        try {
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            firebaseUser = userCredential.user;
            await getUserDataByEmail(email);
            showDashboard();
        } catch (error) {
            errorElement.textContent = "Email, mot de passe ou connexion base de données incorrect.";
            errorElement.classList.remove('hidden');
        } finally {
            loginButton.disabled = false;
            isProcessingAuth = false;
        }
    });

    document.getElementById('signup-modal-submit').addEventListener('click', async () => {
        const email = document.getElementById('signup-modal-email').value.trim();
        const name = document.getElementById('signup-modal-name').value.trim();
        const password = document.getElementById('signup-modal-password').value.trim();
        const errorElement = document.getElementById('signup-modal-error');
        const submitButton = document.getElementById('signup-modal-submit');
        errorElement.classList.add('hidden');
        submitButton.disabled = true;
        isProcessingAuth = true;
        try {
            await auth.createUserWithEmailAndPassword(email, password);
            await createUserData(email, name);
            document.getElementById('signup-modal').classList.add('hidden');
            document.getElementById('signup-success-modal').classList.remove('hidden');
        } catch (error) {
            let message = "Une erreur est survenue.";
            if (error.code === 'auth/email-already-in-use') { message = "Un compte existe déjà."; }
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
        } finally {
            submitButton.disabled = false;
            isProcessingAuth = false;
        }
    });

    // Écouteurs pour les autres modales et boutons
    document.getElementById('show-signup-modal-button').addEventListener('click', () => document.getElementById('signup-modal').classList.remove('hidden'));
    document.getElementById('signup-modal-cancel').addEventListener('click', () => document.getElementById('signup-modal').classList.add('hidden'));
    document.getElementById('signup-success-login-button').addEventListener('click', () => document.getElementById('signup-success-modal').classList.add('hidden'));

    document.getElementById('show-forgot-password-modal').addEventListener('click', () => document.getElementById('forgot-password-modal').classList.remove('hidden'));
    document.getElementById('forgot-password-cancel').addEventListener('click', () => document.getElementById('forgot-password-modal').classList.add('hidden'));
    document.getElementById('forgot-password-submit').addEventListener('click', async () => {
        const email = document.getElementById('forgot-password-email').value;
        const successElement = document.getElementById('forgot-password-success');
        const errorElement = document.getElementById('forgot-password-error');
        try {
            await auth.sendPasswordResetEmail(email);
            successElement.textContent = 'Email envoyé !';
            successElement.classList.remove('hidden');
            errorElement.classList.add('hidden');
        } catch (error) {
            errorElement.textContent = error.message;
            errorElement.classList.remove('hidden');
            successElement.classList.add('hidden');
        }
    });

    document.getElementById('open-profile-modal').addEventListener('click', () => {
        document.getElementById('profile-modal').classList.remove('hidden');
        document.getElementById('profile-email').value = firebaseUser.email;
    });
    document.getElementById('close-profile-modal').addEventListener('click', () => document.getElementById('profile-modal').classList.add('hidden'));
    document.getElementById('cancel-profile-button').addEventListener('click', () => document.getElementById('profile-modal').classList.add('hidden'));
    document.getElementById('save-profile-button').addEventListener('click', async () => {
        const password = document.getElementById('profile-password').value;
        const confirm = document.getElementById('profile-password-confirm').value;
        const errorElement = document.getElementById('profile-error');
        errorElement.classList.add('hidden');
        if (password.length > 0) {
            if (password.length < 6) {
                errorElement.textContent = "Le mot de passe doit comporter au moins 6 caractères.";
                errorElement.classList.remove('hidden');
                return;
            }
            if (password !== confirm) {
                errorElement.textContent = "Les mots de passe ne correspondent pas.";
                errorElement.classList.remove('hidden');
                return;
            }
            try {
                await firebaseUser.updatePassword(password);
                document.getElementById('profile-password').value = '';
                document.getElementById('profile-password-confirm').value = '';
                document.getElementById('profile-modal').classList.add('hidden');
            } catch (error) {
                errorElement.textContent = "Erreur: " + error.message;
                errorElement.classList.remove('hidden');
            }
        } else {
            document.getElementById('profile-modal').classList.add('hidden');
        }
    });

    document.getElementById('logout-button').addEventListener('click', handleLogout);
    document.getElementById('start-debrief-button').addEventListener('click', startDebrief);
document.getElementById('upgrade-button').addEventListener('click', async () => {
    if (!userRecord) return;
    try {
        // On appelle n8n pour créer la session de paiement
        const session = await callN8n('createCheckoutSession', { recordId: userRecord.id });
        if (session.url) {
            // On redirige l'utilisateur vers la page de paiement Stripe
            window.location.href = session.url;
        }
    } catch (error) {
        alert("Erreur lors de la création de la session de paiement : " + error.message);
    }
});

document.getElementById('cancel-premium-button').addEventListener('click', async () => {
    if (!userRecord) return;

    // On demande une confirmation à l'utilisateur
    if (!confirm("Êtes-vous sûr de vouloir annuler votre abonnement ? Cette action est immédiate.")) {
        return; // L'utilisateur a cliqué sur "Annuler"
    }

    try {
        // On désactive le bouton pour éviter les double-clics
        document.getElementById('cancel-premium-button').disabled = true;
        document.getElementById('cancel-premium-button').textContent = 'Annulation en cours...';

        // On appelle la nouvelle action n8n
        const updatedRecord = await callN8n('cancelSubscription', { recordId: userRecord.id });
        
        // On met à jour les données locales et on rafraîchit l'affichage
        updateLocalUserRecord(updatedRecord);
        showDashboard();

    } catch (error) {
        alert("Une erreur est survenue lors de l'annulation : " + error.message);
        // On réactive le bouton en cas d'erreur
        document.getElementById('cancel-premium-button').disabled = false;
        document.getElementById('cancel-premium-button').textContent = 'Annuler l\'abonnement';
    }
});
    
</script>
</body>
</html>













